<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Update Profile - MyShop</title>
  <style>
    body {
         font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
         background: #f2f5fa;
         display: flex;
         justify-content: center;
         align-items: center;
         min-height: 100vh;
         margin: 0;
         padding: 1rem;
       }
       #profile-form {
         background: white;
         padding: 2rem 2.5rem;
         border-radius: 12px;
         box-shadow: 0 8px 20px rgba(0,0,0,0.12);
         max-width: 520px;
         width: 100%;
       }
       #profile-form h2 {
         margin-bottom: 1.5rem;
         color: #0070f3;
         text-align: center;
         font-weight: 700;
         font-size: 1.8rem;
         letter-spacing: 0.02em;
       }
       fieldset {
         border: none;
         margin: 0 0 1.8rem 0;
         padding: 0;
       }
       fieldset.seller-section {
         background: #f9faff;
         border-left: 5px solid #0070f3;
         padding: 1rem 1.5rem;
         border-radius: 6px;
       }
       legend {
         font-size: 1.1rem;
         font-weight: 600;
         color: #005bb5;
         margin-bottom: 1rem;
       }
       label {
         display: block;
         font-weight: 600;
         margin-bottom: 0.3rem;
         color: #333;
         font-size: 0.9rem;
       }
       input, select, button {
         width: 100%;
         padding: 0.8rem 1rem;
         border-radius: 6px;
         border: 1.7px solid #ccc;
         font-size: 1rem;
         font-family: inherit;
         box-sizing: border-box;
         transition: border-color 0.25s ease;
       }
       input:focus, select:focus {
         outline: none;
         border-color: #0070f3;
         box-shadow: 0 0 8px rgba(0,112,243,0.3);
       }
       input[disabled] {
         background: #ececec;
         cursor: not-allowed;
       }
       button {
         background-color: #0070f3;
         color: white;
         font-weight: 700;
         border: none;
         cursor: pointer;
         transition: background-color 0.3s ease;
         margin-top: 0.5rem;
       }
       button:hover {
         background-color: #005bb5;
       }
       #delete-account-btn {
         background-color: #e74c3c;
         margin-top: 1rem;
       }
       #delete-account-btn:hover {
         background-color: #c0392b;
       }
       .message {
         font-weight: 700;
         margin-bottom: 1rem;
         text-align: center;
         font-size: 1.05rem;
       }
       .success {
         color: #27ae60;
       }
       .error {
         color: #e74c3c;
       }
       .two-columns {
         display: grid;
         grid-template-columns: 1fr 1fr;
         gap: 1rem 1.5rem;
       }
       @media (max-width: 480px) {
         .two-columns {
           grid-template-columns: 1fr;
         }
       }
  </style>
</head>
<body>
<form id="profile-form">
  <h2>Update Profile</h2>
  <div id="message" class="message"></div>

  <fieldset>
    <label for="name">Name <sup>*</sup></label>
    <input type="text" id="name" placeholder="Full Name" required />

    <label for="email">Email</label>
    <input type="email" id="email" placeholder="Email" disabled />

    <div class="two-columns">
      <div>
        <label for="phone">Phone</label>
        <input type="tel" id="phone" placeholder="Enter phone number" />
      </div>

      <div>
        <label for="pincode">Pincode</label>
        <input
                type="text"
                id="pincode"
                placeholder="6-digit Pincode"
                maxlength="6"
                pattern="\d{6}"
                inputmode="numeric"
                title="Please enter a 6-digit numeric pincode"
        />
      </div>
      </div>

    <div class="two-columns">
      <div>
        <label for="district">District <sup>*</sup></label>
        <input type="text" id="district" placeholder="District" required />
      </div>
      <div>
        <label for="state">State <sup>*</sup></label>
        <input type="text" id="state" placeholder="State" readonly required />
      </div>
    </div>

    <label for="village">Village</label>
    <input type="text" id="village" placeholder="Village" />

    <label for="town_city">Town/City</label>
    <input type="text" id="town_city" placeholder="Town or city" />

    <label for="address1">Address Line 1</label>
    <input type="text" id="address1" placeholder="Address line 1" />

    <label for="address2">Address Line 2</label>
    <input type="text" id="address2" placeholder="Address line 2" />

    <label for="landmark">Landmark</label>
    <input type="text" id="landmark" placeholder="Nearby landmark" />
  </fieldset>

  <fieldset class="seller-section" id="seller-fields" style="display:none;">
    <legend>Seller Information</legend>

    <label for="gst_number">GST Number <sup>*</sup></label>
    <input type="text" id="gst_number" placeholder="GST Number" />

    <label for="pan_number">PAN Number <sup>*</sup></label>
    <input type="text" id="pan_number" placeholder="PAN Number" />

    <label for="bank_account_number">Bank Account Number <sup>*</sup></label>
    <input type="text" id="bank_account_number" placeholder="Bank Account No" />

    <div class="two-columns">
      <div>
        <label for="ifsc_code">IFSC Code <sup>*</sup></label>
        <input type="text" id="ifsc_code" placeholder="IFSC Code" />
      </div>
      <div>
        <label for="branch_name">Branch Name <sup>*</sup></label>
        <input type="text" id="branch_name" placeholder="Branch Name" readonly />
      </div>
    </div>

    <label for="branch_location">Branch Location <sup>*</sup></label>
    <input type="text" id="branch_location" placeholder="Branch Location" readonly />

    <label for="bank_name">Bank Name</label>
    <input type="text" id="bank_name" placeholder="Bank Name" readonly />

    <label for="upi_id">UPI ID <sup>*</sup></label>
    <input type="text" id="upi_id" placeholder="UPI ID" />
  </fieldset>
  <button type="submit">Save</button>
  <button type="button" id="delete-account">Delete Account</button>
</form>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  // Initialize Supabase client
 const supabase = window.supabase.createClient(
    'https://wamqheltqmufuzrqlxlb.supabase.co',
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndhbXFoZWx0cW11ZnV6cnFseGxiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEwOTQxMzAsImV4cCI6MjA3NjY3MDEzMH0.xFtK5p22bHNzWcGXUgRUR5f-Q4SGdQperlPf4ItD2sY'
  );

  const form = document.getElementById('profile-form');
  const messageDiv = document.getElementById('message');

  const role = ''; // to be fetched after profile load
  const nameInput = document.getElementById('name');
  const emailInput = document.getElementById('email');
  const phoneInput = document.getElementById('phone');
  const pincodeInput = document.getElementById('pincode');
  const districtInput = document.getElementById('district');
  const stateInput = document.getElementById('state');
  const villageInput = document.getElementById('village');
  const address1Input = document.getElementById('address1');
  const address2Input = document.getElementById('address2');
  const landmarkInput = document.getElementById('landmark');

  const gstInput = document.getElementById('gst_number');
  const panInput = document.getElementById('pan_number');
  const bankAccountInput = document.getElementById('bank_account_number');
  const ifscInput = document.getElementById('ifsc_code');
  const branchNameInput = document.getElementById('branch_name');
  const branchLocationInput = document.getElementById('branch_location');
  const bankNameInput = document.getElementById('bank_name');
  const upiInput = document.getElementById('upi_id');

  const sellerSection = document.getElementById('seller-fields');

  // Pincode fetch
  document.getElementById('pincode').addEventListener('blur', () => {
    fetch(`https://api.postalpincode.in/pincode/${pincodeInput.value.trim()}`)
      .then(res => res.json())
      .then(data => {
        if(data[0]?.Status === 'Success') {
          const pm = data[0].PostOffice[0];
          districtInput.value = pm.District || '';
          stateInput.value = pm.State || '';
          villageInput.value = pm.Name || '';
        }
      });
  });

  // IFSC fetch
  document.getElementById('ifsc_code').addEventListener('blur', () => {
    fetch(`https://ifsc.razorpay.com/${ifscInput.value.trim().toUpperCase()}`)
      .then(res => {
        if(!res.ok) throw new Error('Invalid IFSC');
        return res.json();
      })
      .then(data => {
        document.getElementById('bank_name').value = data.BANK || '';
        branchNameInput.value = data.BRANCH || '';
        branchLocationInput.value = data.CITY || data.ADDRESS || '';
      })
      .catch(() => {
        document.getElementById('bank_name').value = '';
        branchNameInput.value = '';
        branchLocationInput.value = '';
      });
  });

  // Load profile on page load
  async function loadProfile() {
    const { data: { user } } = await supabase.auth.getUser();
    if(!user) { window.location = 'login.html'; return; }

    const { data, error } = await supabase
      .from('profiles')
      .select(`name,email,address1,address2,landmark,town_city,pincode,district,state,village,phone,gst_number,pan_number,bank_name,bank_account_number,ifsc_code,branch_name,branch_location,upi_id,role`)
      .eq('id', user.id)
      .single();

    if(error || !data) {
      messageDiv.textContent = 'Failed to load profile.';
      messageDiv.className = 'message error';
      return;
    }

    // Set role based UI toggle
    const role = data.role;
    if(role === 'seller') {
      sellerSection.style.display = 'block';
      // require fields for seller
      gstInput.required = true;
      panInput.required = true;
      bankAccountInput.required = true;
      ifscInput.required = true;
      branchNameInput.required = true;
      branchLocationInput.required = true;
      upiInput.required = true;
    } else {
      sellerSection.style.display = 'none';
      gstInput.required = false;
      panInput.required = false;
      bankAccountInput.required = false;
      ifscInput.required = false;
      branchNameInput.required = false;
      branchLocationInput.required = false;
      upiInput.required = false;
    }

    // Fill form fields
    document.getElementById('name').value = data.name || '';
    document.getElementById('email').value = data.email || '';
    document.getElementById('address1').value = data.address1 || '';
    document.getElementById('address2').value = data.address2 || '';
    document.getElementById('landmark').value = data.landmark || '';
    document.getElementById('town_city').value = data.town_city || '';
    document.getElementById('pincode').value = data.pincode || '';
    document.getElementById('district').value = data.district || '';
    document.getElementById('state').value = data.state || '';
    document.getElementById('village').value = data.village || '';
    document.getElementById('phone').value = data.phone || '';

    // Seller fields
    gstInput.value = data.gst_number || '';
    panInput.value = data.pan_number || '';
    bankAccountInput.value = data.bank_account_number || '';
    ifscInput.value = data.ifsc_code || '';
    branchNameInput.value = data.branch_name || '';
    branchLocationInput.value = data.branch_location || '';
    document.getElementById('bank_name').value = data.bank_name || '';
    upiInput.value = data.upi_id || '';
  }

  // Save profile
  document.querySelector('form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const { data: { user } } = await supabase.auth.getUser();
    if(!user) { alert('Login required'); return; }

    const updateData = {
      id: user.id,
      name: document.getElementById('name').value.trim(),
      address1: document.getElementById('address1').value.trim(),
      address2: document.getElementById('address2').value.trim(),
      landmark: document.getElementById('landmark').value.trim(),
      town_city: document.getElementById('town_city').value.trim(),
      pincode: document.getElementById('pincode').value.trim(),
      district: document.getElementById('district').value.trim(),
      state: document.getElementById('state').value.trim(),
      village: document.getElementById('village').value.trim(),
      phone: document.getElementById('phone').value.trim(),
      gst_number: document.getElementById('gst_number').value.trim() || null,
      pan_number: document.getElementById('pan_number').value.trim() || null,
      bank_name: document.getElementById('bank_name').value.trim() || null,
      bank_account_number: document.getElementById('bank_account_number').value.trim() || null,
      ifsc_code: document.getElementById('ifsc_code').value.trim() || null,
      branch_name: document.getElementById('branch_name').value.trim() || null,
      branch_location: document.getElementById('branch_location').value.trim() || null,
      upi_id: document.getElementById('upi_id').value.trim() || null,
    };

    // Role check for validation
    if(sellerSection.style.display === 'block') {
      if (!updateData.gst_number || !updateData.pan_number || !updateData.bank_name ||
          !updateData.bank_account_number || !updateData.ifsc_code || !updateData.branch_name || !updateData.branch_location || !updateData.upi_id) {
        alert('All seller fields are required');
        return;
      }
    }

    // Validate pincode
    if(updateData.pincode && (updateData.pincode.length !== 6 || isNaN(updateData.pincode))) {
      alert('Invalid Pincode');
      return;
    }

    // Validate required fields
    if(!updateData.district || !updateData.state) {
      alert('Please fill all required fields');
      return;
    }

    // Save to database
    const { error } = await supabase.from('profiles').upsert(updateData);
    document.getElementById('message').textContent = error ? 'Error: ' + error.message : 'Profile saved!';
    document.getElementById('message').className = error ? 'message error' : 'message success';
  });

  // Fetch on load
  window.onload = () => {
    loadProfile();
  };
</script>
</body>
</html>
