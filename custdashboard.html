<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Customer Dashboard - MyShop</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;700&family=Roboto:wght@400;700&display=swap" rel="stylesheet" />
  <style>
    :root {
      --primary: #fbb034;
      --secondary: #232f3e;
      --accent: #e91e63;
      --price: #ed2b77;
      --bg: #f7fafc;
      --card: #fff;
      --border: #e6e7ec;
      --muted: #7a8499;
      --hover: #ffe440;
      --stock: #079c44;
      --danger: #b8062b;
      --sale: #ed2b77;
      --cart-outline: #ffe440;
    }
    html, body { box-sizing: border-box; }
    body { font-family: 'Montserrat', 'Roboto', Arial, sans-serif; background: var(--bg); margin: 0; min-height: 100vh; color: #222; }

    .header { background: linear-gradient(90deg,#232f3e 70%,#fbb034 100%); color: #fff; padding: 1.1rem 4vw 1.15rem 4vw; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 4px 20px #2221; position: sticky; top: 0; z-index: 100; }
    .header h1 { margin: 0; font-size: 2.1rem; font-weight: 700; }
    .nav-group { display: flex; gap: 14px; }
    .nav-group button { background: var(--primary); color: var(--secondary); font-weight: bold; font-size: 1em; border: none; border-radius: 6px; padding: 9px 18px; cursor: pointer; box-shadow: 0 2px 13px #fdbe341a; transition: background .2s, color .2s, transform .08s; }
    .nav-group button:active, .nav-group button:focus { background: var(--secondary); color: #ffd814; }

    main { max-width: 1400px; margin: 2.3rem auto 1.5rem; padding: 0 0.5vw; }
    .pincode-section { display: flex; align-items: center; gap: 10px; margin-bottom: 19px; flex-wrap: wrap; }
    .pincode-input { padding: 8px 12px; border-radius: 17px; font-size: 1.07em; border: 2px solid #ffd814; width: 122px; }
    .check-pincode-btn { background: #232f3e; color: #ffd814; border: none; border-radius: 15px; padding: 7px 14px; font-weight: bold; font-size: 1em; cursor: pointer; transition: background .17s; }
    .check-pincode-btn:hover { background: #ffd814; color: #232f3e; }
    .products-section { background: var(--card); border-radius: 12px; box-shadow: 0 6px 20px #232f3e10; padding: 1.1rem 3px 1.0rem 3px; }
    .products-header { margin-bottom: 1.2rem; border-bottom: 2px solid var(--border); padding-bottom: .28rem; display: flex; flex-wrap: wrap; align-items: flex-end; gap:0.83rem; justify-content: space-between; }
    .products-header h2 { font-size: 1.22rem; font-weight: 700; color: var(--secondary); }
    .search-sort-wrap { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
    .search-bar, .sort-select { padding: .6em 0.7em; font-size: 1em; border-radius: 7px; border: 2px solid var(--border); background: #f8fafb; color: #232f3e; min-width: 85px; transition: border .15s, box-shadow .17s; }

    #products-list { display: grid; grid-template-columns: repeat(auto-fill,minmax(166px,1fr)); gap: 0.3rem 0.3rem; }

    .product-card { background: #fff; border-radius: 9px; box-shadow: 0 2px 14px #232f3e0b; padding: 0.77rem 0.6rem 0.58rem 0.6rem; display: flex; flex-direction: column; align-items: center; position: relative; overflow: hidden; min-width: 0; margin: 0; }
    .offer-badge { display: inline-block; background: #e91e63; color: #fff; font-weight: bold; font-size: 0.86em; padding: 1px 7px 1px 7px; border-radius: 11px; box-shadow: 0 2px 6px #e91e6325; margin-bottom: 3px; margin-top: 1px; letter-spacing: .01em; }
    .star-rating { display: flex; gap:1.5px; align-items:center; justify-content:center; margin-bottom:2px; font-size:0.97em; }
    .star { color: #fdcf25; }
    .star.empty { color: #ddd; }
    .product-img-wrap { width: 92px; min-height: 92px; background: #fafbfe; border-radius: 8px; display: flex; align-items: center; justify-content: center; margin-bottom: 0.53rem; overflow: hidden; }
    .product-card img { width: 87px; height: 87px; border-radius: 5px; object-fit: cover; background: #f6f7fa; display: block; transition: transform .11s cubic-bezier(.34,1.56,.64,1); }
    .product-card:hover img { transform: scale(1.05) rotate(-1.1deg); }
    .product-name { font-size: 1.02rem; font-weight: 700; margin: 0.07rem 0 0.04rem 0; color: #222d48; text-align: left; line-height: 1.23; cursor: pointer; text-decoration: underline; width: 100%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: block; }
    .price-row { display: flex; align-items: center; justify-content:center; gap:5px; margin-bottom: 2px; margin-top: 1px; }
    .product-price { color: var(--price); font-size: 1.03rem; font-weight: bold; letter-spacing: .01em;}
    .mrp-val { font-size: .95em; color: #787; text-decoration: line-through; margin-left:2px;}
    .product-seller { font-size: 0.89em; color: var(--muted); font-style: italic; margin-bottom: 0.04rem; margin-top:2px; text-align: left; width: 100%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: block; }
    .stock-label.low { color: #b8062b; font-weight: bold; font-size:0.86em; margin-bottom:2px;}
    .cart-action-zone { outline: 2px solid var(--cart-outline); outline-offset: -3px; border-radius: 18px; background: #fffbe7; display:flex; align-items:center; justify-content:center; min-height:38px; min-width:108px; margin: 9px 0 3px 0; gap: 0px; padding: 4px 9px 2px 9px; }
    .add-btn-plus { background: #ffd814; color: #232f3e; font-size: 1.4em; border: none; border-radius: 50%; width: 31px; height: 31px; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 6px #ffd81466; cursor: pointer; outline: none; transition: background .13s; }
    .add-btn-plus:active { background: #fbb034; }
    .qty-controls { display: flex; align-items: center; gap: 0; justify-content:center; width: 100%; }
    .qty-btn { background: #ffd814; color: #232f3e; font-weight: bold; font-size: 1.18em; border: none; border-radius: 50%; width: 29px; height: 29px; cursor: pointer; margin: 0 4.5px; box-shadow: 0 1px 5px #ffd81416; transition: background .15s; display: flex; align-items: center; justify-content: center; }
    .qty-btn:disabled { background: #fab;}
    .cart-trash-btn { background: transparent; color: var(--danger); border: none; font-size: 1.09em; border-radius: 50%; width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; cursor: pointer; margin-right: 0px; transition: background .15s; }
    .cart-trash-btn:hover { background: #fbe9e9; }
    .item-qty-label { font-size: 1.15em; font-weight:600; color:#232f3e; width: 26px; text-align:center;}
    .add-cart-btn { font-weight: 700; font-size: .97em; padding: 7px 18px; background: linear-gradient(80deg,#fbb034 60%,#ed2b77 130%); color: #fff; border: none; border-radius: 7px; margin-top: .09rem; cursor: pointer; box-shadow: 0 2px 6px #fbb03420; letter-spacing: .01em; transition: background .13s, color .13s, box-shadow .13s; outline: none; min-width: 95px; }
    .add-cart-btn:disabled { background: #d2d5dc; color: #888; cursor: not-allowed; box-shadow: none; }
    .cart-empty { color: #8c8f9f; background: #f5f6fa; padding: 1.1rem 0.7rem; border-radius: 8px; font-weight: 600; font-size: .98rem; margin-top: 1rem; text-align: center; box-shadow: 0 1px 12px #232f3e10; }

/* Product list grid with wider cards and more gap */
#products-list {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  gap: 1rem 1rem;
  max-width: 1400px;
  margin: 0 auto;
  padding: 1rem 2rem;
}

.product-card {
  background: #ffffff;
  border-radius: 20px;
  box-shadow:
    0 8px 15px rgba(0,0,0,0.12),
    0 3px 6px rgba(0,0,0,0.08),
    inset 0 -12px 36px rgba(255, 184, 52, 0.15);
  padding: 1.3rem 1.2rem 1rem 1.2rem;
  display: flex;
  flex-direction: column;
  align-items: center;
  cursor: pointer;
  transition: box-shadow 0.3s ease, transform 0.3s ease;
  will-change: transform;
}
.product-card:hover {
  box-shadow:
    0 20px 40px rgba(0,0,0,0.18),
    0 6px 12px rgba(0,0,0,0.14),
    inset 0 -24px 48px rgba(255, 184, 52, 0.3);
  transform: translateY(-5px) scale(1.05);
  z-index: 100;
}

.product-img-wrap {
  width: 160px;
  height: 160px;
  background: #fafbfe;
  border-radius: 16px;
  display: flex;
  align-items: center;
  justify-content: center;
  margin-bottom: 1rem;
  overflow: hidden;
  transition: transform 0.4s ease;
}
.product-card:hover .product-img-wrap {
  transform: scale(1.1);
}
.product-card img {
  width: 150px;
  height: 150px;
  border-radius: 12px;
  object-fit: cover;
  display: block;
  box-shadow:
    0 10px 20px rgba(0,0,0,0.1);
  transition: transform 0.4s ease;
}

.product-name {
  font-size: 1.4rem;
  font-weight: 800;
  margin: 0 0 0.3rem 0;
  color: #1f2937;
  text-align: center;
  line-height: 1.35;
  max-width: 100%;
  text-decoration: underline;
}

.price-row {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
  margin-bottom: 6px;
  margin-top: 2px;
}
.product-price {
  color: #e91e63;
  font-size: 1.4rem;
  font-weight: 900;
  letter-spacing: 0.04em;
  text-shadow: 0 1px 2px rgba(233,30,99,0.35);
}
.mrp-val {
  font-size: 1.1rem;
  color: #a1a1aa;
  text-decoration: line-through;
  margin-left: 8px;
  font-weight: 500;
}

/* Sale / offer badge */
.offer-badge {
  position: absolute;
  top: 16px;
  left: 16px;
  background: #e91e63;
  color: #fff;
  font-weight: 700;
  font-size: 0.95em;
  padding: 4px 14px;
  border-radius: 20px;
  text-shadow: 0 1px 3px rgba(0,0,0,0.3);
  box-shadow: 0 4px 8px rgba(233,30,99,0.45);
  user-select: none;
  pointer-events: none;
}

.product-seller {
  font-size: 1.1rem;
  color: #6b7280;
  font-style: italic;
  margin-top: 0;
  margin-bottom: 8px;
  text-align: center;
  width: 100%;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.stock-label.low {
  color: #b8062b;
  font-weight: 700;
  font-size: 1rem;
  margin-bottom: 0.75rem;
}

.cart-action-zone {
  outline: 2px solid #ffe440;
  outline-offset: -3px;
  border-radius: 28px;
  background: #fffbea;
  display: flex;
  align-items: center;
  justify-content: center;
  min-height: 48px;
  min-width: 140px;
  margin: 14px 0 6px 0;
  gap: 0;
  padding: 6px 16px 6px 16px;
  box-shadow: 0 1px 7px rgba(255, 212, 8, 0.45);
  user-select: none;
}

/* Add to cart button */
.add-btn-plus {
  background: #ffe440;
  color: #232f3e;
  font-size: 2em;
  border: none;
  border-radius: 50%;
  width: 48px;
  height: 48px;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 4px 10px #ffe440aa;
  cursor: pointer;
  outline: none;
  transition: background 0.2s ease;
}
.add-btn-plus:active {
  background: #fbb034;
  box-shadow: 0 3px 7px #fbb034aa;
}

/* Quantity controls */
.qty-controls {
  display: flex;
  align-items: center;
  gap: 0;
  justify-content: center;
  width: 100%;
}
.qty-btn {
  background: #ffe440;
  color: #232f3e;
  font-weight: 700;
  font-size: 1.6em;
  border: none;
  border-radius: 50%;
  width: 42px;
  height: 42px;
  cursor: pointer;
  margin: 0 6px;
  box-shadow: 0 3px 10px #ffe44066;
  transition: background 0.2s ease;
  display: flex;
  align-items: center;
  justify-content: center;
}
.qty-btn:disabled {
  background: #fddc6a;
}
.cart-trash-btn {
  background: transparent;
  color: #b8062b;
  border: none;
  font-size: 1.5em;
  border-radius: 50%;
  width: 38px;
  height: 38px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  margin-right: 6px;
  transition: background 0.15s;
}
.cart-trash-btn:hover {
  background: #fbe9e9;
}

/* Quantity label */
.item-qty-label {
  font-size: 1.35em;
  font-weight: 900;
  color: #232f3e;
  width: 34px;
  text-align: center;
}

/* Empty cart message */
.cart-empty {
  color: #6b7280;
  background: #f5f6fa;
  padding: 1.5rem 1.25rem;
  border-radius: 16px;
  font-weight: 900;
  font-size: 1.25rem;
  margin-top: 2rem;
  text-align: center;
  box-shadow: 0 4px 18px rgba(35, 47, 62, 0.28);
}
  </style>
</head>
<body>
<div class="header">
  <h1>MyShop</h1>
  <div class="nav-group">
    <button onclick="window.location.href='profile.html'">Profile</button>
    <button onclick="window.location.href='cart.html'">Your Cart</button>
    <button onclick="window.location.href='order.html'">Your Orders</button>
    <button onclick="logout()">Logout</button>
  </div>
</div>
<main>
  <div class="products-section">
    <div class="pincode-section">
      <input class="pincode-input" id="userPincode" placeholder="Enter Pincode" maxlength="6" pattern="\d{6}" inputmode="numeric" />
      <button class="check-pincode-btn" onclick="renderProducts()">Check</button>
      <span id="pincode-msg" style="color:#b8062b;font-weight:600;"></span>
    </div>
    <div class="products-header">
      <h2>Discover products for you</h2>
      <div class="search-sort-wrap">
        <input class="search-bar" id="searchInput" type="text" placeholder="Search products..." oninput="renderProducts()" />
        <select class="sort-select" id="categorySelect" onchange="onCategoryChange()">
          <option value="">All Categories</option>
        </select>
        <select class="sort-select" id="subCategorySelect" onchange="renderProducts()" disabled>
          <option value="">Select Subcategory</option>
        </select>
        <select class="sort-select" id="sellerSelect" onchange="renderProducts()">
          <option value="">All Sellers</option>
        </select>
        <select class="sort-select" id="sortSelect" onchange="renderProducts()">
          <option value="latest">Sort: Latest</option>
          <option value="name_asc">Name (A-Z)</option>
          <option value="name_desc">Name (Z-A)</option>
          <option value="price_asc">Price Low-High</option>
          <option value="price_desc">Price High-Low</option>
          <option value="category_asc">Category (A-Z)</option>
          <option value="category_desc">Category (Z-A)</option>
        </select>
      </div>
    </div>
    <div id="products-list"></div>
  </div>
</main>
<script>
  const supabase = window.supabase.createClient(
    'https://wamqheltqmufuzrqlxlb.supabase.co',
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndhbXFoZWx0cW11ZnV6cnFseGxiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEwOTQxMzAsImV4cCI6MjA3NjY3MDEzMH0.xFtK5p22bHNzWcGXUgRUR5f-Q4SGdQperlPf4ItD2sY'
  );
  let customerId = null;
  let allProducts = [];
  let allCategories = [];
  let cart = {};
  let salesCountMap = {};

  document.addEventListener('DOMContentLoaded', async () => {
    await loadProducts();
    await loadBestSellerCounts();
    await loadCart();
    // If you want to handle JS-based layout change on resize (not needed for CSS only, but for specific JS logic):
    window.addEventListener('resize', onResponsiveResize);
    onResponsiveResize();
  });

  // Optional JS-based UI tweak for mobile/desktop differences
  function onResponsiveResize() {
    const isMobile = window.innerWidth < 700;
    // Example: show/hide bottom bar, adjust touch optimization, etc.
    // document.body.classList.toggle('is-mobile', isMobile);
    // Add custom JS logic if you want - most layout is handled by CSS above
  }

  async function checkLogin() {
    const { data } = await supabase.auth.getUser();
    if (data.user) customerId = data.user.id;
  }

  async function loadProducts() {
    const { data, error } = await supabase
      .from('products')
      .select('id, name, description, price, mrp, stock, category_id, image_url, accept_cod, seller_id, delivery_location, rating, featured, profiles(name)')
      .order('created_at', { ascending: false });
    if (error) {
      alert('Error loading products: ' + error.message);
      return;
    }
    allProducts = data || [];
    await loadCategories();
    await checkLogin();
    populateSellers();
    renderProducts();
  }

  async function loadBestSellerCounts() {
    const { data, error } = await supabase
      .from('order_items')
      .select('product_id')
      .eq('status', 'completed');
    salesCountMap = {};
    if (data && Array.isArray(data)) {
      for(const row of data) {
        if(!row.product_id) continue;
        salesCountMap[row.product_id] = (salesCountMap[row.product_id] || 0) + 1;
      }
      renderProducts();
    }
  }

  async function loadCategories() {
    const { data, error } = await supabase
      .from('categories')
      .select('id, name, parent_id');
    if (error) {
      alert('Error fetching categories: ' + error.message);
      return;
    }
    allCategories = data;
    const categorySelect = document.getElementById('categorySelect');
    categorySelect.innerHTML = '<option value="">All Categories</option>';
    const topCategories = allCategories.filter(c => c.parent_id === null);
    topCategories.forEach(cat => {
      const opt = document.createElement('option');
      opt.value = cat.id;
      opt.textContent = cat.name;
      categorySelect.appendChild(opt);
    });
    document.getElementById('subCategorySelect').innerHTML = '<option value="">Select Subcategory</option>';
    document.getElementById('subCategorySelect').disabled = true;
  }

  function populateSellers() {
    const sellers = [...new Map(allProducts.filter(p => p.profiles && p.profiles.name)
      .map(p => [p.seller_id, p.profiles.name])).entries()];
    const sellerSelect = document.getElementById('sellerSelect');
    sellerSelect.innerHTML = '<option value="">All Sellers</option>';
    sellers.forEach(([id, name]) => {
      const o = document.createElement('option');
      o.value = id;
      o.textContent = name;
      sellerSelect.appendChild(o);
    });
  }

  function onCategoryChange() {
    const categorySelect = document.getElementById('categorySelect');
    const selectedCatId = parseInt(categorySelect.value);
    const subCatSelect = document.getElementById('subCategorySelect');
    subCatSelect.innerHTML = '<option value="">Select Subcategory</option>';
    subCatSelect.disabled = true;
    if (!selectedCatId) {
      renderProducts();
      return;
    }
    const subcategories = allCategories.filter(c => c.parent_id === selectedCatId);
    if (subcategories.length) {
      subCatSelect.disabled = false;
      subcategories.forEach(subcat => {
        const opt = document.createElement('option');
        opt.value = subcat.id;
        opt.textContent = subcat.name;
        subCatSelect.appendChild(opt);
      });
    }
    renderProducts();
  }

  function getUserPincode() {
    return document.getElementById('userPincode').value.trim();
  }

  window.renderProducts = function() {
    const searchText = document.getElementById('searchInput').value.toLowerCase();
    const categoryFilter = parseInt(document.getElementById('categorySelect').value);
    const subcategoryFilter = parseInt(document.getElementById('subCategorySelect').value);
    const sellerFilter = document.getElementById('sellerSelect').value;
    const sortBy = document.getElementById('sortSelect').value;
    const customerPincode = getUserPincode();
    let pincodeMsg = document.getElementById("pincode-msg");
    if(customerPincode && !/^\d{6}$/.test(customerPincode)){
      pincodeMsg.textContent = "Enter a valid 6-digit pincode!";
    } else {
      pincodeMsg.textContent = "";
    }

    let filtered = allProducts.filter(p => {
      const nameMatch = p.name?.toLowerCase().includes(searchText) || false;
      const descMatch = p.description?.toLowerCase().includes(searchText) || false;
      const catMatch = !categoryFilter || (subcategoryFilter ? p.category_id === subcategoryFilter : p.category_id === categoryFilter);
      const sellerMatch = sellerFilter === '' || p.seller_id === sellerFilter;
      return (nameMatch || descMatch) && catMatch && sellerMatch;
    });

    // Custom order for home: offer > rating > best seller > featured > latest
    filtered.sort((a, b) => {
      // Offer
      let pctA = a.mrp && a.price && a.mrp > a.price ? (a.mrp - a.price) / a.mrp : 0;
      let pctB = b.mrp && b.price && b.mrp > b.price ? (b.mrp - b.price) / b.mrp : 0;
      if (pctA !== pctB) return pctB - pctA;
      // Rating
      let ratingA = parseFloat(a.rating) || 0;
      let ratingB = parseFloat(b.rating) || 0;
      if (ratingA !== ratingB) return ratingB - ratingA;
      // Best Seller
      let soldA = salesCountMap[a.id] || 0;
      let soldB = salesCountMap[b.id] || 0;
      if (soldA !== soldB) return soldB - soldA;
      // Featured
      let featuredA = a.featured ? 1 : 0;
      let featuredB = b.featured ? 1 : 0;
      if (featuredA !== featuredB) return featuredB - featuredA;
      // Fallback by latest (created_at desc is already default)
      return 0;
    });

    const container = document.getElementById('products-list');
    container.innerHTML = '';
    if (!filtered.length) {
      container.innerHTML = '<div class="cart-empty">No products found for your filters.</div>';
      return;
    }

    filtered.forEach((prod, idx) => {
      const isOutStock = prod.stock == null || prod.stock <= 0;
      let images = [];
      try { images = prod.image_url ? JSON.parse(prod.image_url) : []; }
      catch { images = prod.image_url ? [prod.image_url] : []; }
      if (!images.length) images = ['https://via.placeholder.com/130?text=No+Image'];

      let pctOff = '';
      if(prod.mrp && prod.price && prod.mrp > prod.price){
        pctOff = `-${Math.round(100*(prod.mrp - prod.price)/prod.mrp)}% OFF`;
      }
      let offerHtml = pctOff ? `<div class="offer-badge">${pctOff}</div>` : '';
      // Star rating
      const ratingVal = parseFloat(prod.rating) || 0;
      let starHtml = '<div class="star-rating">';
      for(let i=1;i<=5;i++){
        starHtml += `<span class="star${i<=ratingVal ? '' : ' empty'}">&#9733;</span>`;
      }
      starHtml += '</div>';
      let stockHtml = '';
      if(+prod.stock<=2 && +prod.stock>0){
        stockHtml = `<span class="stock-label low">Only ${prod.stock} left!</span>`;
      }
      // Cart controls
      let incart = cart[prod.id] || 0;
      let cartControls = "";
      if (!isOutStock){
        if (incart) {
          cartControls = `
            <div class="qty-controls">
              <button class="cart-trash-btn" onclick="removeFromCart('${prod.id}')">&#128465;</button>
              <button class="qty-btn" onclick="updateQty('${prod.id}', -1)" ${incart<=1 ? "disabled" : ""}>-</button>
              <span class="item-qty-label">${incart}</span>
              <button class="qty-btn" onclick="updateQty('${prod.id}', 1)" ${incart>=prod.stock ? "disabled" : ""}>+</button>
            </div>`;
        } else {
          cartControls = `
            <button class="add-btn-plus" onclick="addToCartHandler('${prod.id}')">+</button>
          `;
        }
      } else {
        cartControls = `<button class="add-cart-btn" disabled>Out of Stock</button>`;
      }
      // card
      const div = document.createElement('div');
      div.className = 'product-card';
      div.tabIndex = 0;
      div.innerHTML = `
        ${offerHtml}
        ${starHtml}
        <div class="product-img-wrap" onclick="window.location.href='productdesc.html?id=${prod.id}'">
          <img src="${images[0]}" alt="${prod.name || ''}" />
        </div>
        <div class="product-name" onclick="window.location.href='productdesc.html?id=${prod.id}'">
          ${prod.name || '-'}
        </div>
        <div class="price-row">
          <span class="product-price">₹${prod.price ?? '-'}</span>
          ${prod.mrp && prod.mrp>prod.price ? `<span class="mrp-val">₹${prod.mrp}</span>` : ''}
        </div>
        <div class="product-seller">Seller: ${prod.profiles?.name || 'N/A'}</div>
        ${stockHtml}
        <div class="cart-action-zone">
          ${cartControls}
        </div>
      `;
      container.appendChild(div);
    });
  };

  async function loadCart() {
    if (!customerId) return;
    const { data, error } = await supabase.from('cart').select('product_id,quantity').eq('customer_id', customerId);
    cart = {};
    if (data && Array.isArray(data)) {
      for (const item of data) { cart[item.product_id] = item.quantity; }
      renderProducts();
    }
  }

  window.addToCartHandler = function(productId) {
    const prod = allProducts.find(p => String(p.id)==String(productId));
    let allowed = true;
    let userPin = getUserPincode();
    if (Array.isArray(prod.delivery_location) && prod.delivery_location.length) {
      if (!userPin || !prod.delivery_location.includes(userPin)) {
        allowed = false;
      }
    }
    if (!allowed) {
      alert('Sorry, this product is not available in your location.');
    } else {
      addToCart(productId);
    }
  };

  window.addToCart = async function(productId) {
    if (!customerId) {
      alert('Please login first to add products to cart.');
      window.location.href = 'login.html';
      return;
    }
    const product = allProducts.find(p => String(p.id) === String(productId));
    if (!product) { alert('Product not found!'); return; }
    if (!product.stock || product.stock <= 0) { alert('Out of stock!'); return; }
    try {
      const { data: item } = await supabase.from('cart').select('*')
        .eq('customer_id', customerId).eq('product_id', productId).maybeSingle();
      if (item) {
        if (item.quantity >= product.stock) {
          alert('You reached max available stock.');
          return;
        }
        await supabase.from('cart').update({ quantity: item.quantity + 1 }).eq('id', item.id);
      } else {
        await supabase.from('cart').insert([{ customer_id: customerId, product_id: productId, quantity: 1 }]);
      }
      cart[productId]=(cart[productId]||0)+1;
      renderProducts();
    } catch (error) {
      alert('Cart Error: ' + error.message);
    }
  };
  window.updateQty = async function(productId, delta) {
    if (!customerId) return;
    const qty = (cart[productId]||0) + delta;
    if (qty < 1) return;
    const { data: item } = await supabase.from('cart').select('id').eq('customer_id', customerId).eq('product_id', productId).maybeSingle();
    if (item) {
      await supabase.from('cart').update({ quantity: qty }).eq('id', item.id);
      cart[productId] = qty;
      renderProducts();
    }
  };
  window.removeFromCart = async function(productId){
    if (!customerId) return;
    const { data: item } = await supabase.from('cart').select('id').eq('customer_id', customerId).eq('product_id', productId).maybeSingle();
    if (item) {
      await supabase.from('cart').delete().eq('id', item.id);
      delete cart[productId];
      renderProducts();
    }
  };

  async function logout() {
    await supabase.auth.signOut();
    customerId = null;
    alert('You have logged out.');
  }

</script>
</body>
</html>
