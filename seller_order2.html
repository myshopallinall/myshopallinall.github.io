<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Seller Order Management</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600&display=swap" rel="stylesheet"/>
  <style>
    body { font-family: 'Montserrat', Arial, sans-serif; margin: 2rem; background: #f4f8fc; }
    h1 { color: #0070f3;}
    #status-message { display: none; padding: 12px 18px; margin-bottom: 18px; background: #e3fbe3; color: #066306; border-radius: 6px; font-weight: bold;}
    table { width: 100%; border-collapse: collapse; box-shadow: 0 1px 6px #ccc; background: white;}
    th, td { padding: 10px; border: 1px solid #ddd;}
    th { background: #eef5ff;}
    button { padding: 6px 13px; margin: 0 2px 0 0; border: none; border-radius: 5px; color: white; cursor: pointer;}
    .btn-delivery { background: #4568ea;}
    .btn-invoice { background: #f9a825; color: #232f3e;}
    .delivery-status-badge { padding: 2px 11px; border-radius: 11px; color: #fff; font-weight: bold;}
    .status-delivered{background: #219f43;}
    .status-pending{background: #e67e22;}
    .status-placed{background: #bfc3cb;}
    .status-shipped{background: #6c63ff;}
    .status-couriered{background: #b24d98;}
    .status-dispatched{background: #2bc26b;}
  </style>
</head>
<body>
<div id="status-message"></div>
<h1>Seller Order Management</h1>
<table id="orders-table">
  <thead>
  <tr>
    <th>Order ID</th>
    <th>Customer</th>
    <th>Status</th>
    <th>Created At</th>
    <th>HSN Code(s)</th>
    <th>Actions</th>
  </tr>
  </thead>
  <tbody></tbody>
</table>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  const supabase = window.supabase.createClient(
    'https://wamqheltqmufuzrqlxlb.supabase.co',
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.xFtK5p22bHNzWcGXUgRUR5f-Q4SGdQperlPf4ItD2sY'
  );
  function showStatusMessage(msg, bg='#e3fbe3', fg='#066306') {
    const div = document.getElementById('status-message');
    div.innerText = msg; div.style.display = 'block'; div.style.background=bg; div.style.color=fg;
    setTimeout(()=>{div.style.display='none';}, 3000);
  }
  let currentUser = null;
  const DELIVERY_STATUSES = ["placed","shipped","couriered","dispatched","delivered"];
  async function loadSellerOrders() {
    const { data: { user } } = await supabase.auth.getUser();
    if (!user) { alert('Please login first!'); window.location.href = 'login.html'; return; }
    currentUser = user;
    const { data: orders, error } = await supabase.from('orders')
      .select(`
        id,customer_id,total,status,created_at,payment_id,
        profiles:customer_id(name,email,phone),
        order_items(id,product_id,quantity,price,delivery_status,is_cod,cod_payment_status,hsn_code,products(name),profiles_seller:seller_id(id))
      `).order('created_at', { ascending: false });
    if (error) { showStatusMessage('Failed to load: ' + error.message, '#ffeded', '#a10021'); return; }
    const tbody = document.querySelector('#orders-table tbody');
    tbody.innerHTML = '';
    orders.filter(order =>
      order.order_items.some(item => item.profiles_seller && item.profiles_seller.id === user.id)
    ).forEach(order => {
      const itemsMine = order.order_items.filter(item => item.profiles_seller && item.profiles_seller.id === user.id);
      const itemCodes = itemsMine.map(item => item.hsn_code || '-').join(', ');
      const isOnlinePaid = order.payment_id && order.payment_id !== "-";
      const allCODPaid = itemsMine.every(i=>i.is_cod && i.cod_payment_status==="paid");
      const isCOD = itemsMine.some(i=>i.is_cod);
      const paidStatus = isOnlinePaid || (isCOD && allCODPaid);
      const overallStatus = paidStatus ? 'delivered' : (order.status || "pending");
      const statusBadge = `<span class="delivery-status-badge status-${overallStatus}">${paidStatus ? "Paid" : (order.status||"Pending").toUpperCase()}</span>`;
      let tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${order.id}</td>
        <td>${order.profiles.name}</td>
        <td>${statusBadge}</td>
        <td>${new Date(order.created_at).toLocaleString()}</td>
        <td>${itemCodes}</td>
        <td>
          <button class="btn-delivery" onclick="window.location.href='dispatch.html?order_id=${order.id}'">Delivery Details</button>
          <button class="btn-invoice" onclick="window.location.href='invoice.html?order_id=${order.id}'">Invoice Details</button>
        </td>
      `;
      tbody.appendChild(tr);
    });
  }
  window.onload = loadSellerOrders;
</script>
</body>
</html>
