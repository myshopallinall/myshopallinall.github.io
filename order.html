<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Your Orders - MyShop</title>
  <meta name="google-adsense-account" content="ca-pub-1893226892962344">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet" />
  <style>
    body { font-family: 'Montserrat', Arial, sans-serif; background: #f3f4f6; margin: 0; padding-bottom: 50px;}
    .header { background: linear-gradient(90deg, #232f3e 70%, #0070f3 100%); padding: 1rem 2.5rem; color: white; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 3px 12px rgb(0 112 243 / 0.25); position: sticky; top: 0; z-index: 10;}
    .header h1 { font-weight: 700; font-size: 2.2rem; margin: 0; letter-spacing: 1px;}
    .nav-group button { background: transparent; border: none; color: white; margin-left: 16px; font-weight: 600; font-size: 1rem; cursor: pointer; padding: 0.5rem 0.8rem; transition: background-color 0.2s ease; border-radius: 4px;}
    .nav-group button:hover { background-color: rgba(255, 255, 255, 0.15);}
    main { max-width: 900px; margin: 2rem auto; padding: 0 1rem; }
    h2 { font-weight: 700; font-size: 1.8rem; border-bottom: 2px solid #0070f3; padding-bottom: 8px; margin-bottom: 1.5rem; color: #1e293b; }
    .order-card { background: white; border-radius: 8px; box-shadow: 0 3px 7px rgb(0 0 0 / 0.07); padding: 1.5rem 1.8rem; margin-bottom: 1.8rem; transition: box-shadow 0.3s ease;}
    .order-card:hover { box-shadow: 0 7px 20px rgb(0 0 0 / 0.12);}
    .order-header { display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 1rem; flex-wrap: wrap; gap: 12px;}
    .order-id { font-weight: 700; font-size: 1.2rem; color: #0070f3;}
    .order-date { color: #64748b; font-size: 0.9rem;}
    .order-info { color: #e91e63; font-weight: 600; font-size: 0.95rem;}
    .order-total { font-weight: 700; font-size: 1.2rem; color: #158a00; white-space: nowrap;}
    table { width: 100%; border-collapse: collapse; font-size: 0.95rem; color: #334155;}
    th, td { text-align: left; padding: 11px 14px; border-bottom: 1px solid #e2e8f0;}
    th { background-color: #f8fafc; color: #0f172a; font-weight: 700; font-size: 0.95rem; letter-spacing: 0.03em;}
    .cod-badge, .paid-badge, .pending-badge { font-size: .89em; font-weight: 600; border-radius: 4px; padding: 2px 8px; display: inline-block; margin-left: 3px; margin-right: 3px; white-space: nowrap;}
    .cod-badge { background: #ffe600; color: #3f330a;}
    .paid-badge { background: #158a00; color: #fff;}
    .pending-badge { background: #e67e22; color: #fff;}
    .status-badge { font-weight: 600; text-transform: capitalize; padding: 4px 8px; border-radius: 4px; color: white; display: inline-block;}
    .prod-status-placed { background-color: #bfc3cb;color:#334;}
    .prod-status-shipped { background-color: #6c63ff;}
    .prod-status-couriered { background-color: #b24d98;}
    .prod-status-dispatched { background-color: #2bc26b;}
    .prod-status-delivered { background-color: #16a34a;}
    .prod-status-pending { background-color: #f97316;}
    a.tracking-link { color: #0070f3; text-decoration: none; font-weight: 600;}
    a.tracking-link:hover { text-decoration: underline;}
    .order-empty { text-align: center; font-size: 1rem; color: #94a3b8; margin-top: 3rem;}
    @media (max-width: 650px) { .order-header { flex-direction: column; align-items: flex-start; gap: 6px;} .order-total { margin-top: 6px;} th, td { padding: 8px 10px; font-size: 0.9rem;} }
  </style>
</head>
<body>
<div class="header">
  <h1>MyShop</h1>
  <div class="nav-group">
    <button onclick="window.location.href='custdashboard.html'">Home</button>
    <button onclick="window.location.href='cart.html'">Your Cart</button>
    <button onclick="window.location.href='returnrequest.html'">Return Request</button>
    <button onclick="logout()">Logout</button>
  </div>
</div>
<main>
  <h2>Your Orders</h2>
  <div id="orders-list"></div>
</main>
<script>
  const supabase = window.supabase.createClient(
    'https://wamqheltqmufuzrqlxlb.supabase.co',
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndhbXFoZWx0cW11ZnV6cnFseGxiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEwOTQxMzAsImV4cCI6MjA3NjY3MDEzMH0.xFtK5p22bHNzWcGXUgRUR5f-Q4SGdQperlPf4ItD2sY'
  );
  let customerId = null;
  checkLogin();
  async function checkLogin(){
    const { data } = await supabase.auth.getUser();
    if (!data.user) { alert('Please login first!'); window.location.href = 'login.html'; }
    customerId = data.user.id;
    loadOrders();
  }
  async function loadOrders(){
    const { data: orders, error } = await supabase
      .from("orders")
      .select(`
        id, total, created_at, status, payment_id,
        order_items(
          id, product_id, quantity, price, status, delivery_status, cod_payment_status,
          variant_id,
          products(name, price),
          product_variants(price, color, size, sku),
          courier_name, courier_tracking_number, courier_tracking_url
        )
      `)
      .eq("customer_id", customerId)
      .order("created_at", { ascending: false });
    const container = document.getElementById("orders-list");
    if (error || !orders || !orders.length) {
      container.innerHTML = '<div class="order-empty">No orders yet.</div>'; return;
    }
    let html = "";
    orders.forEach(order => {
      if (!order.order_items || !order.order_items.length) return;
      let isPaid = false;
      if (order.payment_id && order.payment_id !== "-") {
        isPaid = true;
      } else if (
        order.order_items.length > 0 &&
        order.order_items.every(i => i.cod_payment_status === "paid")
      ) {
        isPaid = true;
      }
      let statusTxt = isPaid ? "paid" : (order.status || "pending");
      let statusColor = isPaid ? "color:#158a00;" :
        (statusTxt === "pending" || statusTxt === "Pending" ? "color:#e91e63;" : "color:#111;");
      html += `<div class="order-card">
        <div class="order-header">
          <span class="order-id">Order #${order.id}</span>
          <span class="order-date">${new Date(order.created_at).toLocaleString()}</span>
          <span class="order-info" style="${statusColor}">Status: <strong>${statusTxt.charAt(0).toUpperCase()+statusTxt.slice(1)}</strong></span>
          <span class="order-info" style="color:#158a00;">Payment ID: ${(order.payment_id || '-')}</span>
          <span class="order-total">Total: ₹${(order.total ?? 0).toFixed(2)}</span>
        </div>
        <table>
          <thead>
            <tr>
              <th>Product</th>
              <th>Qty</th>
              <th>Unit Price</th>
              <th>Subtotal</th>
              <th>Delivery Status</th>
              <th>COD Payment</th>
              <th>Tracking</th>
            </tr>
          </thead>
          <tbody>`;
      order.order_items.forEach(item => {
        const prodName = item.products?.name ?? "-";
        const variantLabel =
          item.product_variants && (item.product_variants.color || item.product_variants.size)
          ? `<br><small>Color: ${item.product_variants.color || "-"} &nbsp; Size: ${item.product_variants.size || "-"}</small>`
          : "";
        const unitPrice = (item.product_variants?.price ?? item.price ?? item.products?.price ?? 0);
        const subtotal = (unitPrice * (item.quantity || 1)).toFixed(2);
        let trackingHtml = '-';
        if (item.courier_tracking_number) {
          if (item.courier_tracking_url) {
            trackingHtml = `<div>${item.courier_name || ''}<br><a href="${item.courier_tracking_url}" class="tracking-link" target="_blank" rel="noopener noreferrer">${item.courier_tracking_number}</a></div>`;
          } else {
            trackingHtml = `<div>${item.courier_name || ''}<br>${item.courier_tracking_number}</div>`;
          }
        }
        let delivStatus = (item.delivery_status || item.status || "pending").toLowerCase();
        let statusClass = ["placed","shipped","couriered","dispatched","delivered"].includes(delivStatus)
          ? "prod-status-" + delivStatus
          : "prod-status-pending";
        let paymentBadge = "";
        if (item.cod_payment_status === "paid") {
          paymentBadge = '<span class="paid-badge">COD Paid</span>';
        } else if (item.cod_payment_status === "pending") {
          paymentBadge = '<span class="pending-badge">COD Pending</span>';
        } else {
          paymentBadge = '<span class="cod-badge">Not COD</span>';
        }
        html += `<tr>
          <td>${prodName}${variantLabel}</td>
          <td>${item.quantity}</td>
          <td>₹${unitPrice.toFixed(2)}</td>
          <td>₹${subtotal}</td>
          <td><span class="status-badge ${statusClass}">${delivStatus.charAt(0).toUpperCase()+delivStatus.slice(1)}</span></td>
          <td>${paymentBadge}</td>
          <td>${trackingHtml}</td>
        </tr>`;
      });
      html += `</tbody></table></div>`;
    });
    container.innerHTML = html;
  }
  window.logout = async function() {
    await supabase.auth.signOut();
    window.location.href = "login.html";
  };
</script>
</body>
</html>
