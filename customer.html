<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Customer Portal - MyShop</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Montserrat', Arial, sans-serif; background: #f6f7fa; margin:0; }
    .header { background: linear-gradient(90deg,#232f3e 70%,#0070f3 100%); color: #fff; padding: 1rem 2.4rem; display: flex; align-items: center; justify-content: space-between; box-shadow:0 3px 8px #0070f335; position:sticky; top:0; z-index:99; }
    .header h1 { font-size:2.1rem; letter-spacing:1px; margin:0;}
    .header .nav-group button { margin-left:12px; font-size:1rem; padding:8px 17px; border:none; border-radius:3px; cursor:pointer; background:#ffe600; color:#232f3e; font-weight:bold; box-shadow:0 2px 6px #0001; transition:background 0.2s;}
    .header .nav-group button:hover { background:#f2c700; }
    main { max-width:1200px; margin:2rem auto 1rem;}
    .products-section {margin-top:1.5rem;}
    .products-header {display:flex;justify-content:space-between;align-items:center;}
    .products-header h2 {font-size:1.45rem;margin-bottom:0.7rem;}
    .search-sort-wrap { display:flex; gap:12px; align-items:center;}
    .search-bar { padding:7px 15px; font-size:1rem; border-radius:5px; border:1px solid #ccc;}
    .sort-select { padding:7px 8px; border-radius:5px; border:1px solid #ccc; font-size:1rem;}
    #products-list { display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:1.6rem;}
    .product-card { background:#fff; border-radius:12px; padding:1.3rem 1rem; box-shadow:0 2px 14px #232f3e10; display:flex; flex-direction:column; align-items:center; transition:box-shadow 0.18s,transform 0.18s; position:relative; min-height:330px;}
    .product-card:hover { box-shadow: 0 6px 18px #232f3e24; transform:translateY(-5px);}
    .badge {position:absolute;top:12px;right:12px;background:#e91e63;color:#fff;font-size:0.92rem;padding:5px 11px;border-radius:20px;font-weight:600;box-shadow:0 1px 5px #e91e6322;}
    .product-card img { width:128px;height:128px;border-radius:7px;object-fit:cover;background:#f6f7fa;margin-bottom:0.9rem; }
    .product-name { font-weight:700; margin-bottom:0.35rem; color:#232f3e; font-size:1.09rem;}
    .product-price { color:#e91e63; font-weight:bold; font-size:1.12rem;}
    .product-desc { margin:0.5rem 0 0.1rem 0;color:#555;font-size:0.97rem;word-break:break-word;}
    .add-cart-btn { margin-top:1.05rem; padding:8px 30px; background:#232f3e; color:#ffe600; border-radius:5px; border:none; font-weight:700; letter-spacing:0.5px; font-size:1.05rem; cursor:pointer; box-shadow:0 2px 7px #232f3e14; transition:background 0.18s;}
    .add-cart-btn:disabled { background:#bbb; color:#fff; cursor:not-allowed; }
    .add-cart-btn:hover:enabled { background:#0070f3; color:#fff;}
    .stock-label { display:block; margin-top:8px; font-size:0.97rem;}
    .section {background:#fff;padding:2rem 1.5rem;border-radius:9px;box-shadow:0 2px 11px #232f3e12;margin-bottom:1rem;}
    table { width:100%; border-collapse:collapse; margin:1.2rem auto 0;background:#fff;}
    th,td { padding:10px 8px; border:1px solid #eee; font-size:1rem;}
    th { background:#f8fbfd; color:#0070f3; font-weight:700;}
    .cart-empty,.order-empty {color:#666; background:#fcfcfc; padding:1rem; border-radius:8px;}
    .place-order-btn { margin-top:1rem;background:#e91e63;color:#fff;font-weight:bold;padding:11px 34px;border:none;border-radius:6px;cursor:pointer;font-size:1.07rem;box-shadow:0 2px 8px #e91e6326;}
    .place-order-btn:hover { background:#c0392b;}
    .prod-status-ind { padding:2px 8px; border-radius:5px; margin-right:3px; font-size:0.99em;}
    .prod-status-pending{background:#ffe600;color:#222;}
    .prod-status-confirmed{background:#3498db;color:#fff;}
    .prod-status-delivered{background:#27ae60;color:#fff;}
    /* Modal for Return Request */
    .modal-bg {
      display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
      background: rgba(0,0,0,0.32); z-index: 6000; justify-content: center; align-items: flex-start;
    }
    .modal-bg.active { display: flex; }
    .modal-returns {
      background: #fff; border-radius: 11px; max-width: 900px; margin: 48px auto 0; width:96%;
      box-shadow: 0 10px 40px #16161629; padding: 2.1rem 1rem 1.2rem 1rem; position: relative;
      animation: popin 0.13s;
    }
    @keyframes popin { from {transform:scale(0.98); opacity:0;} to {transform:scale(1); opacity:1;} }
    .modal-returns h2 { margin-top: 0; }
    .modal-returns-close {
      position:absolute; top:15px; right:18px; color:#0070f3; font-size:2.3rem; font-weight:bold; background:none; border:none; cursor:pointer;
    }
    #returnForm table { margin:0; }
    #returnForm button[type="submit"] { margin-top:1rem; }
    #return-msg { text-align:center; font-weight:700; margin-top:1rem; }
    @media (max-width: 700px) {
      .modal-returns {padding: 1rem 0.3rem 1.2rem 0.3rem;}
      .modal-returns h2 { font-size:1.25rem;}
    }
  </style>
</head>
<body>
<div class="header">
  <h1>MyShop</h1>
  <div class="nav-group">
    <button id="profile-btn">Your Profile</button>
    <button id="returns-btn">Return Request</button>
    <button id="logout-btn">Logout</button>
  </div>
</div>
<main>
  <div class="products-section">
    <div class="products-header">
      <h2>Latest Products</h2>
      <div class="search-sort-wrap">
        <input class="search-bar" id="searchInput" type="text" placeholder="Search products..." oninput="renderProducts()" />
        <select class="sort-select" id="categorySelect" onchange="renderProducts()">
          <option value="">All Categories</option>
        </select>
        <select class="sort-select" id="sellerSelect" onchange="renderProducts()">
          <option value="">All Sellers</option>
        </select>
        <select class="sort-select" id="sortSelect" onchange="renderProducts()">
          <option value="latest">Sort: Latest</option>
          <option value="name_asc">Name (A-Z)</option>
          <option value="name_desc">Name (Z-A)</option>
          <option value="price_asc">Price Low-High</option>
          <option value="price_desc">Price High-Low</option>
          <option value="category_asc">Category (A-Z)</option>
          <option value="category_desc">Category (Z-A)</option>
        </select>
      </div>
    </div>
    <div id="products-list"></div>
  </div>
  <div class="section">
    <h2>Your Cart</h2>
    <div id="cart-list"></div>
    <button class="place-order-btn" onclick="startPayment()">Proceed to Pay</button>
  </div>
  <div class="section">
    <h2>Your Orders</h2>
    <div id="orders-list"></div>
    <button id="returns-btn-orders" style="margin-top:15px; padding:10px 22px; font-weight:bold; background:#e91e63; border:none; color:white; border-radius:5px; cursor:pointer;">
      Request a Return
    </button>
  </div>
</main>

<!-- Return Request Modal -->
<div class="modal-bg" id="returnModalBg">
  <div class="modal-returns">
    <button class="modal-returns-close" type="button" onclick="closeReturnModal()">&times;</button>
    <h2>Request a Return</h2>
    <p>Only products from orders placed within the last 7 days are eligible.</p>
    <form id="returnForm">
      <table>
        <thead>
        <tr>
          <th>Select</th>
          <th>Order ID</th>
          <th>Product</th>
          <th>Order Date</th>
          <th>Qty</th>
          <th>Reason</th>
        </tr>
        </thead>
        <tbody id="orderItemsBody"></tbody>
      </table>
      <button id="submitReturnBtn" type="submit" disabled>Submit Return Request</button>
    </form>
    <div id="return-msg"></div>
    <div id="yourReturns" style="margin-top:18px"></div>
  </div>
</div>

<script>
  const supabase = window.supabase.createClient(
    'https://wamqheltqmufuzrqlxlb.supabase.co',
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndhbXFoZWx0cW11ZnV6cnFseGxiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEwOTQxMzAsImV4cCI6MjA3NjY3MDEzMH0.xFtK5p22bHNzWcGXUgRUR5f-Q4SGdQperlPf4ItD2sY'
  );
  let customerId = null;
  let latestCart = [], latestTotal = 0;
  let allProducts = [];
   let codAcceptMap = {};

  async function checkLogin() {
    const { data } = await supabase.auth.getUser();
    if (!data.user) {
      alert('Please login first!');
      window.location.href = 'login.html';
      return;
    }
    customerId = data.user.id;
    await loadProducts();
await loadOrders();
loadCart();
    loadOrders();
  }

  async function loadProducts() {
 async function loadOrders() {
  const { data: orders, error } = await supabase
    .from("orders")
    .select("id, total, created_at, status, payment_id, order_items(product_id, quantity, price, status, products(name), courier_name, courier_tracking_number, courier_tracking_url)")
    .eq("customer_id", customerId)
    .order("created_at", { ascending: false });

  const container = document.getElementById("orders-list");
  if (error || !orders.length) {
    container.innerHTML = '<div class="order-empty">No orders yet.</div>';
    return;
  }
  let html = "";
  orders.forEach(order => {
    html += `<div style="margin-bottom:1.3rem;">
      <strong>Order #${order.id}</strong>
      <span style="color:#888;">(${order.created_at.slice(0, 19).replace("T", " ")})</span>
      <span style="color:#e91e63;">Status: ${order.status}</span>
      <span style="color:#15a100; margin-left:16px;">Payment ID: ${order.payment_id || '-'}</span>
      <span style="color:#0070f3;float:right;">Total: ₹${order.total}</span><br>
      <table>
        <tr><th>Product</th><th>Qty</th><th>Unit Price</th><th>Subtotal</th><th>Delivery Status</th><th>Tracking</th></tr>`;
    order.order_items.forEach(item => {
      let trackingHtml = '-';
      if (item.courier_tracking_number) {
        if (item.courier_tracking_url) {
          trackingHtml = `<div>${item.courier_name || ''}<br><a href="${item.courier_tracking_url}" target="_blank" rel="noopener noreferrer">${item.courier_tracking_number}</a></div>`;
        } else {
          trackingHtml = `<div>${item.courier_name || ''}<br>${item.courier_tracking_number}</div>`;
        }
      }

      let prodStatusClass = "prod-status-ind prod-status-pending";
      if(item.status === "delivered") prodStatusClass = "prod-status-ind prod-status-delivered";
      else if(item.status === "confirmed") prodStatusClass = "prod-status-ind prod-status-confirmed";

      html += `<tr>
        <td>${item.products.name}</td>
        <td>${item.quantity}</td>
        <td>₹${item.price}</td>
        <td>₹${item.price * item.quantity}</td>
        <td><span class="${prodStatusClass}">${item.status || 'pending'}</span></td>
        <td>${trackingHtml}</td>
      </tr>`;
    });
    html += `</table></div>`;
  });
  container.innerHTML = html;
}
 }

  function populateCategories() {
    const categories = [...new Set(allProducts.map(p => p.category).filter(Boolean))].sort();
    const categorySelect = document.getElementById('categorySelect');
    categorySelect.innerHTML = '<option value="">All Categories</option>';
    categories.forEach(cat => {
      const option = document.createElement('option');
      option.value = cat;
      option.textContent = cat;
      categorySelect.appendChild(option);
    });
  }


  function populateSellers() {
    const sellers = [...new Map(
  allProducts
    .filter(p => p.profiles && p.profiles.name)
    .map(p => [p.seller_id, p.profiles.name])
).entries()];
const sellerSelect = document.getElementById('sellerSelect');
sellerSelect.innerHTML = '<option value="">All Sellers</option>';
sellers.forEach(([id, name]) => {
  const option = document.createElement('option');
  option.value = id;
  option.textContent = name;
  sellerSelect.appendChild(option);
});
}

 window.renderProducts = function () {
      const searchText = document.getElementById('searchInput').value.toLowerCase();
      const categoryFilter = document.getElementById('categorySelect').value;
      const sellerFilter = document.getElementById('sellerSelect').value;
      const sortBy = document.getElementById('sortSelect').value;

      let filtered = allProducts.filter(p => {
        const nameMatch = p.name ? p.name.toLowerCase().includes(searchText) : false;
        const descMatch = p.description ? p.description.toLowerCase().includes(searchText) : false;
        const catMatch = categoryFilter === '' || p.category === categoryFilter;
       const sellerMatch = sellerFilter === '' || p.seller_id === sellerFilter;
       return (nameMatch || descMatch) && catMatch && sellerMatch;
      });

    if (sortBy === 'name_asc') filtered.sort((a, b) => (a.name || '').localeCompare(b.name || ''));
    else if (sortBy === 'name_desc') filtered.sort((a, b) => (b.name || '').localeCompare(a.name || ''));
    else if (sortBy === 'price_asc') filtered.sort((a, b) => (a.price || 0) - (b.price || 0));
    else if (sortBy === 'price_desc') filtered.sort((a, b) => (b.price || 0) - (a.price || 0));
    else if (sortBy === 'category_asc') filtered.sort((a, b) => (a.category || '').localeCompare(b.category || ''));
    else if (sortBy === 'category_desc') filtered.sort((a, b) => (b.category || '').localeCompare(a.category || ''));

    const container = document.getElementById('products-list');
    container.innerHTML = '';
    if (!filtered.length) {
      container.innerHTML = '<div class="cart-empty">No products found.</div>';
      return;
    }
    filtered.forEach(prod => {
      const isOutStock = prod.stock === null || prod.stock === undefined || prod.stock <= 0;
      const addDisabled = isOutStock ? 'disabled' : '';
      let div = document.createElement('div');
      div.className = 'product-card';
      div.innerHTML = `
        <div class="badge">${prod.price && prod.price < 500 ? "Best Seller" : "Featured"}</div>
        <img src="${prod.image_url || 'https://via.placeholder.com/128'}" alt="${prod.name || ''}" />
        <div class="product-name">${prod.name || '-'}</div>
        <div class="product-price">₹${prod.price !== undefined ? prod.price : '-'}</div>
        <div class="product-desc">${prod.description || ''}</div>
        <div><em>Category: ${prod.category || 'N/A'}</em></div>
      <div><em>Seller: ${prod.profiles?.name || 'N/A'}</em></div>
      <span class="stock-label" style="color:${isOutStock ? '#e91e63':'#158a00'};">
          ${isOutStock ? 'Out of Stock' : ('In Stock: ' + prod.stock)}
        </span>
        <button class="add-cart-btn" ${addDisabled} onclick="addToCart('${prod.id}')">
          ${isOutStock ? 'Out of Stock' : 'Add to Cart'}
        </button>
      `;
      container.appendChild(div);
    });
  };

  window.addToCart = async function(productId) {
    const product = allProducts.find(p => p.id == productId);
    if (!product) {
      alert('Product not found!');
      return;
    }
    if (!product.stock || product.stock <= 0) {
      alert('Sorry, this product is currently out of stock.');
      return;
    }

    try {
      const { data: item, error: selectError } = await supabase
        .from('cart')
        .select('*')
        .eq('customer_id', customerId)
        .eq('product_id', productId)
        .maybeSingle();
      if (selectError) throw selectError;

      if (item) {
        if (item.quantity >= product.stock) {
          alert('You have reached the maximum available stock for this product.');
          return;
        }
        const { error: updateError } = await supabase
          .from('cart')
          .update({ quantity: item.quantity + 1 })
          .eq('id', item.id);
        if (updateError) throw updateError;
      } else {
        const { error: insertError } = await supabase
          .from('cart')
          .insert([{ customer_id: customerId, product_id: productId, quantity: 1 }]);
        if (insertError) throw insertError;
      }
      await loadCart();
    } catch (error) {
      alert('Cart Error: ' + error.message);
    }
  };

  async function loadCart() {
   const { data, error } = await supabase
  .from('cart')
  .select('id, product_id, quantity, products(name, price, seller_id, stock, accept_cod)')
  .eq('customer_id', customerId);
 const container = document.getElementById('cart-list');
    if (error || !data.length) {
      container.innerHTML = '<div class="cart-empty">Your cart is empty.</div>';
      latestCart = [];
      latestTotal = 0;
      return;
    }
    let html = `<table>
      <tr><th>Product</th><th>Price</th><th>Qty</th><th>Total</th><th>Remove</th></tr>`;
    data.forEach(item => {
      html += `<tr>
        <td>${item.products.name}</td>
        <td>₹${item.products.price}</td>
        <td>${item.quantity}</td>
        <td>₹${item.quantity * item.products.price}</td>
        <td><button onclick="removeFromCart('${item.id}')" style="background:#e74c3c;color:#fff;padding:4px 12px;border:none;border-radius:4px;cursor:pointer;">Delete</button></td>
      </tr>`;
    });
    html += '</table>';
    container.innerHTML = html;
    latestCart = data;
    latestTotal = data.reduce((sum, item) => sum + (item.products.price * item.quantity), 0);
  }

  window.removeFromCart = async function(cartId) {
    await supabase.from('cart').delete().eq('id', cartId);
    loadCart();
  };

 window.startPayment = function() {
  if (!latestCart.length || latestTotal === 0) {
    alert('Cart is empty!');
    return;
  }

  let codAllowed = true;
  for (let item of latestCart) {
    if (!item.products.accept_cod) {
      codAllowed = false;
      break;
    }
  }

  if (codAllowed) {
    const useCOD = confirm('COD is available for your products. Click OK for Cash on Delivery, Cancel for Online Payment.');
    if (useCOD) {
      placeOrder(latestCart, latestTotal, null, 'cod');
      return;
    }
  } else {
    alert('COD is not available for some products in your cart. Please use Online Payment.');
  }

  let options = {
    key: "rzp_test_RWfoVf4VK0sQaK",
    amount: latestTotal * 100,
    currency: "INR",
    name: "MyShop",
    description: "Order Payment",
    handler: function(response) {
      placeOrder(latestCart, latestTotal, response.razorpay_payment_id, 'online');
    },
    prefill: {
      email: "customer@domain.com",
    },
    theme: { color: "#0070f3" }
  };
  let rzp = new Razorpay(options);
  rzp.open();
};
    window.placeOrder = async function(cartItems, totalAmount, paymentId, paymentType='online') {
      try {
        if (!cartItems.length) {
          alert("Cart is empty!");
          return;
        }
        const orderStatus = paymentType === 'cod' ? 'pending' : 'paid';

        const { data: order, error: orderError } = await supabase
          .from("orders")
          .insert([
            { customer_id: customerId, total: totalAmount, payment_id: paymentId, status: orderStatus },
          ])
          .select()
          .single();

        if (orderError || !order) {
          alert("Order failed! " + (orderError?.message || ""));
          return;
        }
        for (let item of cartItems) {
          await supabase.from("order_items").insert([
            {
              order_id: order.id,
              product_id: item.product_id,
              seller_id: item.products.seller_id,
              quantity: item.quantity,
              price: item.products.price,
              status: 'pending'
            }
          ]);
          const newStock = (item.products.stock || 0) - item.quantity;
          if (newStock < 0) { continue; }
          await supabase.from('products').update({ stock: newStock }).eq('id', item.product_id);
        }
        await supabase.from("cart").delete().eq("customer_id", customerId);
        alert(`Order placed successfully! Payment method: ${paymentType === 'cod' ? 'Cash On Delivery' : 'Online Payment'}`);
        loadProducts();
        loadCart();
        loadOrders();
      } catch (err) {
        alert("Order saving error: " + err.message);
      }
    };

 async function loadOrders() {
  const { data: orders, error } = await supabase
    .from("orders")
    .select(`
      id,
      total,
      created_at,
      status,
      payment_id,
      order_items(
        product_id,
        quantity,
        price,
        status,
        products(name),
        courier_name,
        courier_tracking_number,
        courier_tracking_url
      )
    `)
    .eq("customer_id", customerId)
    .order("created_at", { ascending: false });

  const container = document.getElementById("orders-list");
  if (error || !orders.length) {
    container.innerHTML = '<div class="order-empty">No orders yet.</div>';
    return;
  }
  let html = "";
  orders.forEach(order => {
    html += `<div style="margin-bottom:1.3rem;">
      <strong>Order #${order.id}</strong>
      <span style="color:#888;">(${order.created_at.slice(0, 19).replace("T", " ")})</span>
      <span style="color:#e91e63;">Status: ${order.status}</span>
      <span style="color:#15a100; margin-left:16px;">Payment ID: ${order.payment_id || '-'}</span>
      <span style="color:#0070f3;float:right;">Total: ₹${order.total}</span><br>
      <table>
        <tr>
          <th>Product</th>
          <th>Qty</th>
          <th>Unit Price</th>
          <th>Subtotal</th>
          <th>Delivery Status</th>
          <th>Tracking</th>
        </tr>`;
    order.order_items.forEach(item => {
      let trackingHtml = '-';
      if (item.courier_tracking_number) {
        if (item.courier_tracking_url) {
          trackingHtml = `<div>${item.courier_name || ''}<br>
            <a href="${item.courier_tracking_url}" target="_blank" rel="noopener noreferrer">
              ${item.courier_tracking_number}</a></div>`;
        } else {
          trackingHtml = `<div>${item.courier_name || ''}<br>${item.courier_tracking_number}</div>`;
        }
      }
      let prodStatusClass = "prod-status-ind prod-status-pending";
      if(item.status === "delivered") prodStatusClass = "prod-status-ind prod-status-delivered";
      else if(item.status === "confirmed") prodStatusClass = "prod-status-ind prod-status-confirmed";

      html += `<tr>
        <td>${item.products.name}</td>
        <td>${item.quantity}</td>
        <td>₹${item.price}</td>
        <td>₹${item.price * item.quantity}</td>
        <td><span class="${prodStatusClass}">${item.status || 'pending'}</span></td>
        <td>${trackingHtml}</td>
      </tr>`;
    });
    html += `</table></div>`;
  });
  container.innerHTML = html;
}


async function loadProducts() {
  // This assumes products.seller_id references profiles.id
  const { data, error } = await supabase
    .from('products')
    .select(`
      id,
      name,
      description,
      price,
      stock,
      category,
      image_url,
      accept_cod,
      seller_id,
      profiles(name)
    `)
    .order('id', { ascending: false });

  if (error) {
    alert("Failed to load products: " + error.message);
    allProducts = [];
    renderProducts();
    return;
  }
  allProducts = data || [];
  populateCategories();
  populateSellers();
  renderProducts();
}

 document.getElementById("profile-btn").onclick = function () {
    window.location.href = "profile.html";
  };

  function openReturnModal() {
    document.getElementById('returnModalBg').classList.add('active');
    loadOrderItemsForReturn();
  }
  function closeReturnModal() {
    document.getElementById('returnModalBg').classList.remove('active');
    document.getElementById('return-msg').textContent = "";
    document.getElementById('orderItemsBody').innerHTML = '';
    document.getElementById('yourReturns').innerHTML = '';
  }
  document.getElementById('returns-btn').onclick = openReturnModal;
  document.getElementById('returns-btn-orders').onclick = openReturnModal;

  let selectedReturnItems = new Map();
  function updateReturnSubmitButton() {
    document.getElementById('submitReturnBtn').disabled = selectedReturnItems.size === 0;
  }

  async function loadOrderItemsForReturn() {
    const msg = document.getElementById('return-msg');
    msg.textContent = "Loading your recent order items...";
    const orderItemsBody = document.getElementById("orderItemsBody");
    selectedReturnItems.clear();
    const sevenDaysAgoISO = new Date(Date.now() - 7*24*60*60*1000).toISOString();
    const {data: orders, error: ordersError} = await supabase
      .from('orders')
      .select('id, created_at')
      .eq('customer_id', customerId)
      .gte('created_at', sevenDaysAgoISO);

    if (ordersError) {
      msg.textContent = "Failed to load orders: " + ordersError.message;
      msg.style.color = "red";
      return;
    }
    const orderIds = orders ? orders.map(o => o.id) : [];

    let orderItems = [];
    if (orderIds.length) {
      const { data: items, error: oiError } = await supabase
        .from('order_items')
        .select('id, order_id, quantity, returned, products(name), orders(created_at)')
        .in('order_id', orderIds)
        .or('returned.is.null,returned.eq.false')
        .order('order_id', { ascending: false });
      if (oiError) {
        msg.textContent = "Failed to load order items: " + oiError.message;
        msg.style.color = "red";
        return;
      }
      orderItems = items;
    }

    if (!orderItems.length) {
      orderItemsBody.innerHTML = `<tr><td colspan="6" style="text-align:center;">No eligible order items found.</td></tr>`;
      msg.textContent = "";
      updateReturnSubmitButton();
      loadCustomerReturnsList();
      return;
    }

    msg.textContent = "";
    orderItemsBody.innerHTML = "";
    orderItems.forEach(item => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><input type="checkbox" data-item-id="${item.id}" /></td>
        <td>${item.order_id}</td>
        <td>${item.products.name}</td>
        <td>${item.orders.created_at ? new Date(item.orders.created_at).toLocaleDateString() : ''}</td>
        <td>${item.quantity}</td>
        <td><textarea disabled placeholder="Enter reason for return"></textarea></td>
      `;
      orderItemsBody.appendChild(tr);

      const checkbox = tr.querySelector('input[type="checkbox"]');
      const textarea = tr.querySelector('textarea');

      checkbox.addEventListener('change', () => {
        if (checkbox.checked) {
          textarea.disabled = false;
          selectedReturnItems.set(item.id, { id: item.id, quantity: item.quantity, reason: '' });
        } else {
          textarea.disabled = true;
          textarea.value = '';
          selectedReturnItems.delete(item.id);
        }
        updateReturnSubmitButton();
      });

      textarea.addEventListener('input', () => {
        if (selectedReturnItems.has(item.id)) {
          selectedReturnItems.get(item.id).reason = textarea.value.trim();
        }
      });
    });
    updateReturnSubmitButton();
    loadCustomerReturnsList();
  }

  document.getElementById('returnForm').addEventListener('submit', async e => {
    e.preventDefault();
    const msg = document.getElementById('return-msg');
    msg.textContent = "";
    if (selectedReturnItems.size === 0) {
      msg.textContent = "Select at least one item to return.";
      msg.style.color = "red";
      return;
    }
    for (const item of selectedReturnItems.values()) {
      if (!item.reason || item.reason.length < 5) {
        msg.textContent = "Please provide a reason of at least 5 characters for all selected items.";
        msg.style.color = "red";
        return;
      }
    }
    try {
      for (const item of selectedReturnItems.values()) {
        let { error: insertError } = await supabase.from('returns').insert([{
          order_item_id: item.id,
          quantity: item.quantity,
          reason: item.reason,
          customer_id: customerId,
          created_at: new Date().toISOString()
        }]);
        if (insertError) throw insertError;
        await supabase.from('order_items').update({ returned: true }).eq('id', item.id);
      }
      msg.style.color = "green";
      msg.textContent = "Return request submitted successfully.";
      selectedReturnItems.clear();
      updateReturnSubmitButton();
      loadOrderItemsForReturn();
      loadOrders();
    } catch (err) {
      msg.style.color = "red";
      msg.textContent = "Failed to submit returns: " + err.message;
    }
  });

  async function loadCustomerReturnsList() {
    const returnsDiv = document.getElementById('yourReturns');
    const { data, error } = await supabase
      .from('returns')
      .select(`created_at, reason, quantity, order_item_id, order_items(order_id, product_id, products(name), orders(customer_id)), customer_id`)
      .eq('customer_id', customerId)
      .order('created_at', { ascending: false })
      .limit(10);
    if (error || !data.length) {
      returnsDiv.innerHTML = `<div style="color:#888; font-size:0.98rem;">No past returns in last 10 entries.</div>`;
      return;
    }

    let html = `<h3 style="margin-top:15px; font-size:1.11rem;">Your Recent Returns</h3><table style="font-size:0.98em; margin-top:8px;"><tr>
        <th>Order</th>
        <th>Product</th>
        <th>Qty</th>
        <th>Reason</th>
        <th>Date</th>
    </tr>`;
    for (const r of data) {
      html += `<tr>
        <td>${r.order_items ? r.order_items.order_id : ''}</td>
        <td>${r.order_items && r.order_items.products ? r.order_items.products.name : ''}</td>
        <td>${r.quantity}</td>
        <td>${r.reason}</td>
        <td>${new Date(r.created_at).toLocaleDateString()}</td>
      </tr>`;
    }
    html += `</table>`;
    returnsDiv.innerHTML = html;
  }

  document.getElementById("logout-btn").onclick = async () => {
    await supabase.auth.signOut();
    window.location.href = "login.html";
  };

  checkLogin();
</script>
</body>
</html>
