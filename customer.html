<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Customer Portal - MyShop</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f8fbfd; margin:0; padding:1.6rem;}
    h1, h2 { color: #0070f3; margin-bottom:1.1rem;}
    nav { display:flex;justify-content:space-between;align-items:center;margin-bottom:2rem;}
    nav button { padding:8px 16px;background:#e74c3c;color:#fff;border:none;border-radius:5px;cursor:pointer;}
    nav button:hover { background:#c0392b;}
    #products-list { display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:1.2rem;}
    .product-card { background:white;border-radius:8px;padding:1rem;box-shadow:0 2px 8px #0070f330;text-align:center;}
    .product-card img { width:120px;height:120px;object-fit:cover;background:#fafafa;margin-bottom:0.7rem;}
    .product-name { font-weight:700;margin-bottom:0.3rem;color:#0070f3;}
    .product-price { color:#e91e63;font-weight:bold;}
    .product-desc { margin:0.4rem 0 0.1rem 0;color:#555;font-size:0.97rem;word-break:break-word;}
    .add-cart-btn { margin-top:0.9rem;padding:7px 18px;background:#0070f3;color:#fff;border-radius:5px;border:none;font-weight:600;cursor:pointer;}
    .add-cart-btn:hover { background:#005bb5;}
    #cart-list,#orders-list { margin-top:2rem;}
    table { width:100%;border-collapse:collapse;margin-top:0.5rem;background:#fff;}
    table th,table td { border:1px solid #eee;padding:8px;text-align:left;font-size:0.98rem;}
    table th { background:#f1f6fa;}
    .place-order-btn { margin-top:1rem;background:#e91e63;color:#fff;font-weight:bold;padding:10px 22px;border:none;border-radius:6px;cursor:pointer;}
    .place-order-btn:hover { background:#c0392b;}
  </style>
</head>
<body>
<nav>
  <h1>Customer Portal</h1>
  <button id="logout-btn">Logout</button>
</nav>
<h2>Products</h2>
<div id="products-list"></div>
<h2>Your Cart</h2>
<div id="cart-list"></div>
<button class="place-order-btn" onclick="placeOrder()">Place Order</button>
<h2>Your Orders</h2>
<div id="orders-list"></div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  const supabase = window.supabase.createClient(
    'https://wamqheltqmufuzrqlxlb.supabase.co',
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndhbXFoZWx0cW11ZnV6cnFseGxiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEwOTQxMzAsImV4cCI6MjA3NjY3MDEzMH0.xFtK5p22bHNzWcGXUgRUR5f-Q4SGdQperlPf4ItD2sY'
  );
  let customerId = null;

  async function checkLogin() {
    const { data } = await supabase.auth.getUser();
    if (!data.user) {
      alert('Please login first!'); window.location.href = 'login.html'; return;
    }
    customerId = data.user.id;
    loadProducts();
    loadCart();
    loadOrders();
  }

  async function loadProducts() {
    const { data, error } = await supabase.from('products').select('*');
    const container = document.getElementById('products-list');
    container.innerHTML = '';
    if (error || !data.length) {
      container.innerHTML = '<div>No products available.</div>'; return;
    }
    data.forEach(prod => {
      const div = document.createElement('div');
      div.className = 'product-card';
      div.innerHTML = `
        <img src="${prod.image_url||''}" alt="${prod.name}" />
        <div class="product-name">${prod.name}</div>
        <div class="product-price">₹${prod.price}</div>
        <div class="product-desc">${prod.description||''}</div>
        <button class="add-cart-btn" onclick="addToCart('${prod.id}', ${prod.price})">Add to Cart</button>
      `;
      container.appendChild(div);
    });
  }

  window.addToCart = async function(productId, productPrice) {
    try {
      // Check if already exists
      const { data: item, error: selectError } = await supabase
        .from('cart')
        .select('*')
        .eq('customer_id', customerId)
        .eq('product_id', productId)
        .maybeSingle();
      if (selectError) throw selectError;
      if (item) {
        const { error: updateError } = await supabase
          .from('cart')
          .update({ quantity: item.quantity + 1 })
          .eq('id', item.id);
        if (updateError) throw updateError;
      } else {
        const { error: insertError } = await supabase
          .from('cart')
          .insert([{ customer_id: customerId, product_id: productId, quantity: 1 }]);
        if (insertError) throw insertError;
      }
      await loadCart();
    } catch (error) {
      alert('Cart Error: ' + error.message);
    }
  }

  async function loadCart() {
    const { data, error } = await supabase
      .from('cart')
      .select('id, product_id, quantity, products(name, price)')
      .eq('customer_id', customerId);
    const container = document.getElementById('cart-list');
    if (error || !data.length) { container.innerHTML = '<div>Cart empty.</div>'; return; }
    let html = `<table>
      <tr><th>Product</th><th>Price</th><th>Qty</th><th>Total</th><th>Remove</th></tr>`;
    data.forEach(item => {
      html += `<tr>
        <td>${item.products.name}</td>
        <td>₹${item.products.price}</td>
        <td>${item.quantity}</td>
        <td>₹${item.quantity * item.products.price}</td>
        <td><button onclick="removeFromCart('${item.id}')">Delete</button></td>
      </tr>`;
    });
    html += '</table>';
    container.innerHTML = html;
  }

  window.removeFromCart = async function(cartId) {
    await supabase.from('cart').delete().eq('id', cartId);
    loadCart();
  }

  window.placeOrder = async function() {
    // Get current cart
    const { data: cartItems } = await supabase
      .from('cart')
      .select('product_id, quantity, products(price, seller_id)')
      .eq('customer_id', customerId);
    if (!cartItems.length) { alert('Cart is empty!'); return; }
    // Calculate total
    let totalAmount = cartItems.reduce((sum, item) => sum + (item.quantity * item.products.price), 0);
    // Create order
    const { data: order, error: orderError } = await supabase
      .from('orders')
      .insert([{ customer_id: customerId, total: totalAmount }])
      .select()
      .single();
    if (orderError || !order) { alert('Order failed!'); return; }
    // Add order_items
    for (let item of cartItems) {
      await supabase.from('order_items').insert([{
        order_id: order.id,
        product_id: item.product_id,
        seller_id: item.products.seller_id,
        quantity: item.quantity,
        price: item.products.price
      }]);
    }
    // Clear cart
    await supabase.from('cart').delete().eq('customer_id', customerId);
    alert('Order placed successfully!');
    loadCart(); loadOrders();
  }

  async function loadOrders() {
    const { data: orders, error } = await supabase
      .from('orders')
      .select('id, total, created_at, status, order_items(product_id, quantity, price, products(name))')
      .eq('customer_id', customerId).order('created_at', { ascending: false });
    const container = document.getElementById('orders-list');
    if (error || !orders.length) { container.innerHTML = '<div>No orders yet.</div>'; return; }
    let html = '';
    orders.forEach(order => {
      html += `<div style="margin-bottom:1.3rem;">
        <strong>Order #${order.id}</strong> <span style="color:#888;">(${order.created_at.slice(0,19).replace('T',' ')})</span>
        <span style="color:#e91e63;">Status: ${order.status}</span> <span style="color:#0070f3;float:right;">Total: ₹${order.total}</span><br>
        <table><tr><th>Product</th><th>Qty</th><th>Unit Price</th><th>Subtotal</th></tr>`;
      order.order_items.forEach(item => {
        html += `<tr>
          <td>${item.products.name}</td>
          <td>${item.quantity}</td>
          <td>₹${item.price}</td>
          <td>₹${item.price * item.quantity}</td>
        </tr>`;
      });
      html += `</table></div>`;
    });
    container.innerHTML = html;
  }

  document.getElementById('logout-btn').onclick = async () => {
    await supabase.auth.signOut();
    window.location.href = 'login.html';
  };

  checkLogin();
</script>
</body>
</html>
