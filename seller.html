<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Seller Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f9f9f9; margin: 0; padding: 2rem; }
    h1, h2 { color: #0070f3; }
    form { background: white; border-radius: 6px; padding: 1rem; margin-bottom: 2rem; max-width: 480px; box-shadow: 0 3px 8px rgba(0,0,0,0.07); }
    form input, form textarea, form select { width: 100%; margin: 0.6rem 0; padding: 0.5rem; font-size: 1rem; border: 1.5px solid #ddd; border-radius: 4px; }
    form label.option-label { font-size: 1.05rem; padding: 0 0.25rem 0 0; display:inline-block;}
    form .checkbox-row { display: flex; gap: 24px; align-items: center; margin: 0.6rem 0;}
    form button { background: #0070f3; border: none; padding: 0.7rem 1.2rem; color: white; font-size: 1rem; border-radius: 4px; cursor: pointer; margin-top: 1rem; }
    form button:hover { background: #005bb5; }
    #products-list { display: grid; grid-template-columns: repeat(auto-fit, minmax(270px, 1fr)); gap: 1rem; }
    .product-card { background: white; border-radius: 6px; padding: 1rem; box-shadow: 0 1px 5px rgba(0,0,0,0.1); text-align: center; }
    .product-card img { width: 120px; height: 120px; object-fit: contain; margin-bottom: 0.7rem; }
    .product-name { font-weight: 600; margin-bottom: 0.5rem; color: #0070f3; }
    .product-price { color: #e91e63; font-weight: bold; margin-bottom: 0.3rem; }
    .product-desc { font-size: 0.95rem; color: #666; }
    nav { display: flex; justify-content: space-between; margin-bottom: 20px; }
    nav .nav-group { display: flex; gap: 10px;}
    nav button { padding: 8px 14px; background: #e74c3c; color: #fff; border: none; border-radius: 5px; cursor: pointer; }
    nav button#orders-btn { background:#0070f3;}
    nav button#profile-btn { background:#27ae60; }
    nav button:hover { opacity:0.88;}
    .edit-btn { background:#27ae60!important; margin-top:7px;}
    .delete-btn { background:#e74c3c!important; margin-top:7px;}
    .cancel-edit-btn { background:#e74c3c!important; margin-left:8px;}
    .stock-label { font-weight:bold; margin-top:0.42rem; display:inline-block; padding: 2px 7px; border-radius: 8px;}
    .in-stock { background: #e6ffe4; color: #158a00;}
    .out-stock { background: #ffebeb; color: #c0392b;}
    .option-tag { font-size: 0.92rem; padding: 2px 8px; border-radius: 10px; background: #f8fafe; display: inline-block; margin:3px; }
    .cod-yes { color: #158a00; background: #d7ffe7;}
    .online-yes { color: #0070f3; background: #d7f2ff;}
    .cod-no, .online-no { color: #b10; background: #ffeaea; }
    #returns-list table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
    #returns-list th, #returns-list td { border: 1px solid #ddd; padding: 8px; text-align: left; }
    #returns-list th { background-color: #0070f3; color: white; }

    /* Multiple Image Preview Styles */
    .image-preview-container { display: flex; flex-wrap: wrap; gap: 10px; margin: 10px 0; }
    .image-preview-item { position: relative; width: 100px; height: 100px; border: 2px solid #ddd; border-radius: 5px; overflow: hidden; }
    .image-preview-item img { width: 100%; height: 100%; object-fit: cover; }
    .image-preview-item .remove-img { position: absolute; top: 2px; right: 2px; background: #e74c3c; color: white; border: none; border-radius: 50%; width: 24px; height: 24px; cursor: pointer; font-size: 16px; line-height: 20px; }
    .image-preview-item .remove-img:hover { background: #c0392b; }
    .image-preview-item .size-badge { position: absolute; bottom: 2px; left: 2px; background: rgba(0,0,0,0.7); color: white; font-size: 10px; padding: 2px 5px; border-radius: 3px; }
    .product-images-gallery { display: flex; gap: 5px; flex-wrap: wrap; justify-content: center; margin-bottom: 8px; }
    .product-images-gallery img { width: 60px; height: 60px; object-fit: cover; border-radius: 4px; border: 1px solid #ddd; }
    .compression-info { font-size: 0.85rem; color: #666; margin-top: 5px; }
  </style>
</head>
<body>
<nav>
  <h1>Seller Dashboard</h1>
  <div class="nav-group">
    <button id="profile-btn">Profile</button>
    <button id="orders-btn">Seller Orders</button>
    <button id="logout-btn">Logout</button>
  </div>
</nav>

<form id="product-form">
  <input type="hidden" id="prod-id" />
  <input type="text" id="prod-name" placeholder="Product Name" required />
  <input type="text" id="category" placeholder="Category" required />
  <input type="text" id="hsn-code" placeholder="HSN Code" required />
  <input type="number" id="prod-price" placeholder="Price (₹)" required />
  <input type="number" id="prod-stock" placeholder="Stock (Qty)" min="0" required />
  <textarea id="prod-desc" placeholder="Description"></textarea>

  <label for="prod-image-file" style="display:block; margin-top:10px; font-weight:bold;">Product Images (Max 5, auto-compressed to ~50KB)</label>
  <input type="file" id="prod-image-file" accept="image/*" multiple />
  <div class="compression-info" id="compression-info"></div>
  <div id="image-preview-container" class="image-preview-container"></div>

  <div class="checkbox-row" style="margin:0.8rem 0;">
    <label class="option-label"><input type="checkbox" id="accept-cod" checked /> Accept COD</label>
    <label class="option-label"><input type="checkbox" id="accept-online" checked /> Accept Online Payment</label>
  </div>
  <button type="submit">Add Product</button>
  <button type="button" id="cancel-edit-btn" class="cancel-edit-btn" style="display:none;">Cancel Edit</button>
</form>

<h2>Your Products</h2>
<div id="products-list"></div>

<h2>Return Requests</h2>
<div id="returns-list"></div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  const supabase = window.supabase.createClient(
    'https://wamqheltqmufuzrqlxlb.supabase.co',
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndhbXFoZWx0cW11ZnV6cnFseGxiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEwOTQxMzAsImV4cCI6MjA3NjY3MDEzMH0.xFtK5p22bHNzWcGXUgRUR5f-Q4SGdQperlPf4ItD2sY'
  );
  let sellerId = null;
  let selectedFiles = [];
  let existingImages = [];
  let compressedFiles = []; // Store compressed blob/file objects

  async function getUser() {
    const { data } = await supabase.auth.getUser();
    if (data && data.user) {
      sellerId = data.user.id;
      await checkSellerDetails();
      loadSellerProducts();
      loadSellerReturns();
    } else {
      alert('Please log in first!');
      window.location.href = 'login.html';
    }
  }

  async function checkSellerDetails() {
    const { data, error } = await supabase.from('profiles').select('gst_number, pan_number').eq('id', sellerId).single();
    if (error || !data) {
      alert('Could not get seller details. Please login again.');
      window.location.href = 'login.html';
      return;
    }
    if (!data.gst_number || !data.pan_number) {
      alert('Please update your GST and PAN numbers in your profile before adding products.');
      window.location.href = 'profile.html';
    }
  }

  // Image Compression Function
  async function compressImage(file, targetSizeKB = 50) {
    return new Promise((resolve) => {
      const reader = new FileReader();
      reader.onload = (e) => {
        const img = new Image();
        img.onload = () => {
          const canvas = document.createElement('canvas');
          const ctx = canvas.getContext('2d');

          // Start with original dimensions
          let width = img.width;
          let height = img.height;

          // Resize if image is too large (max 800px on longest side)
          const maxSize = 800;
          if (width > maxSize || height > maxSize) {
            if (width > height) {
              height = (height / width) * maxSize;
              width = maxSize;
            } else {
              width = (width / height) * maxSize;
              height = maxSize;
            }
          }

          canvas.width = width;
          canvas.height = height;
          ctx.drawImage(img, 0, 0, width, height);

          // Binary search for optimal quality
          let quality = 0.9;
          let blob = null;
          let iterations = 0;
          const maxIterations = 10;

          const tryCompress = (q) => {
            return new Promise((res) => {
              canvas.toBlob((b) => {
                res(b);
              }, 'image/jpeg', q);
            });
          };

          const compress = async () => {
            while (iterations < maxIterations) {
              blob = await tryCompress(quality);
              const sizeKB = blob.size / 1024;

              console.log(`Iteration ${iterations + 1}: Quality ${quality.toFixed(2)}, Size: ${sizeKB.toFixed(2)}KB`);

              if (sizeKB <= targetSizeKB * 1.1 && sizeKB >= targetSizeKB * 0.8) {
                // Within acceptable range (±10%)
                break;
              } else if (sizeKB > targetSizeKB) {
                quality -= 0.1;
              } else {
                quality += 0.05;
              }

              quality = Math.max(0.1, Math.min(1, quality));
              iterations++;
            }

            const finalFile = new File([blob], file.name, { type: 'image/jpeg' });
            resolve({ file: finalFile, size: blob.size });
          };

          compress();
        };
        img.src = e.target.result;
      };
      reader.readAsDataURL(file);
    });
  }

  // Handle file selection and compression
  document.getElementById('prod-image-file').addEventListener('change', async function(e) {
    const files = Array.from(e.target.files);
    if (selectedFiles.length + files.length > 5) {
      alert('You can upload maximum 5 images');
      return;
    }

    const compressionInfo = document.getElementById('compression-info');
    compressionInfo.textContent = 'Compressing images...';

    for (const file of files) {
      if (selectedFiles.length < 5) {
        try {
          const { file: compressedFile, size } = await compressImage(file, 50);
          selectedFiles.push({ original: file, compressed: compressedFile, size });
          console.log(`Original: ${(file.size / 1024).toFixed(2)}KB -> Compressed: ${(size / 1024).toFixed(2)}KB`);
        } catch (error) {
          console.error('Compression error:', error);
          alert('Failed to compress image: ' + file.name);
        }
      }
    }

    compressionInfo.textContent = `${selectedFiles.length} image(s) compressed successfully!`;
    setTimeout(() => { compressionInfo.textContent = ''; }, 3000);
    renderImagePreviews();
  });

  function renderImagePreviews() {
    const container = document.getElementById('image-preview-container');
    container.innerHTML = '';

    // Show existing images (in edit mode)
    existingImages.forEach((url, index) => {
      const div = document.createElement('div');
      div.className = 'image-preview-item';
      div.innerHTML = `
        <img src="${url}" />
        <button class="remove-img" type="button" onclick="removeExistingImage(${index})">&times;</button>
      `;
      container.appendChild(div);
    });

    // Show newly selected compressed files
    selectedFiles.forEach((fileObj, index) => {
      const reader = new FileReader();
      reader.onload = function(e) {
        const sizeKB = (fileObj.size / 1024).toFixed(1);
        const div = document.createElement('div');
        div.className = 'image-preview-item';
        div.innerHTML = `
          <img src="${e.target.result}" />
          <span class="size-badge">${sizeKB}KB</span>
          <button class="remove-img" type="button" onclick="removeSelectedFile(${index})">&times;</button>
        `;
        container.appendChild(div);
      };
      reader.readAsDataURL(fileObj.compressed);
    });
  }

  window.removeSelectedFile = function(index) {
    selectedFiles.splice(index, 1);
    renderImagePreviews();
  };

  window.removeExistingImage = function(index) {
    existingImages.splice(index, 1);
    renderImagePreviews();
  };

  async function uploadImage(file) {
    const fileName = `${Date.now()}_${Math.random().toString(36).substring(7)}_${file.name}`;
    let { error: uploadError } = await supabase.storage
      .from('product-images')
      .upload(fileName, file);
    if (uploadError) {
      console.error('Image upload failed:', uploadError.message);
      return null;
    }
    const { data: urlData } = supabase.storage
      .from('product-images')
      .getPublicUrl(fileName);
    return urlData.publicUrl;
  }

  document.getElementById('product-form').onsubmit = async function(e) {
    e.preventDefault();
    const prodId = document.getElementById('prod-id').value || null;
    const name = document.getElementById('prod-name').value;
    const category = document.getElementById('category').value;
    const hsn_code = document.getElementById('hsn-code').value;
    const price = parseInt(document.getElementById('prod-price').value, 10);
    const stock = parseInt(document.getElementById('prod-stock').value, 10);
    const description = document.getElementById('prod-desc').value;
    const accept_cod = document.getElementById('accept-cod').checked;
    const accept_online_payment = document.getElementById('accept-online').checked;

    // Upload compressed images
    let imageUrls = [...existingImages];
    for (let fileObj of selectedFiles) {
      const url = await uploadImage(fileObj.compressed);
      if (url) imageUrls.push(url);
    }

    let productData = {
      seller_id: sellerId,
      name,
      category,
      hsn_code,
      price,
      stock,
      description,
      accept_cod,
      accept_online_payment,
      image_url: imageUrls.length > 0 ? JSON.stringify(imageUrls) : null
    };

    if (prodId) {
      const { error } = await supabase.from('products')
        .update(productData)
        .eq('id', prodId);
      if (error) {
        alert('Failed to update product: ' + error.message);
      } else {
        alert('Product updated successfully!');
        resetForm();
        loadSellerProducts();
      }
    } else {
      const { error } = await supabase.from('products').insert([productData]);
      if (error) {
        alert('Failed to add product: ' + error.message);
      } else {
        alert('Product added successfully!');
        resetForm();
        loadSellerProducts();
      }
    }
  };

  function resetForm() {
    document.getElementById('product-form').reset();
    document.getElementById('prod-id').value = '';
    document.getElementById('cancel-edit-btn').style.display = 'none';
    document.querySelector("#product-form button[type=submit]").textContent = "Add Product";
    document.getElementById('accept-cod').checked = true;
    document.getElementById('accept-online').checked = true;
    selectedFiles = [];
    existingImages = [];
    renderImagePreviews();
  }

  async function loadSellerProducts() {
    const { data, error } = await supabase.from('products').select('*').eq('seller_id', sellerId);
    if (error) {
      alert('Error loading products: ' + error.message);
      return;
    }
    const container = document.getElementById('products-list');
    container.innerHTML = '';
    data.forEach(prod => {
      const cod = prod.accept_cod ? '<span class="option-tag cod-yes">COD</span>' : '<span class="option-tag cod-no">No COD</span>';
      const online = prod.accept_online_payment ? '<span class="option-tag online-yes">Online</span>' : '<span class="option-tag online-no">No Online</span>';

      let images = [];
      try {
        images = prod.image_url ? JSON.parse(prod.image_url) : [];
      } catch (e) {
        images = prod.image_url ? [prod.image_url] : [];
      }

      let imagesHtml = '';
      if (images.length > 0) {
        imagesHtml = '<div class="product-images-gallery">';
        images.forEach(url => {
          imagesHtml += `<img src="${url}" alt="${prod.name}" />`;
        });
        imagesHtml += '</div>';
      } else {
        imagesHtml = '<img src="https://via.placeholder.com/120" alt="No image" />';
      }

      const div = document.createElement('div');
      div.className = 'product-card';
      div.innerHTML = `
        ${imagesHtml}
        <div class="product-name">${prod.name}</div>
        <div><b>Category:</b> ${prod.category || '-'}</div>
        <div><b>HSN Code:</b> ${prod.hsn_code || '-'}</div>
        <div class="product-price">₹${prod.price}</div>
        <div class="product-desc">${prod.description || ''}</div>
        <div>
          <span class="stock-label ${prod.stock > 0 ? 'in-stock':'out-stock'}">
            ${prod.stock > 0 ? 'In Stock (' + prod.stock + ')':'Out of Stock'}
          </span>
        </div>
        <div style="margin-top:6px;">${cod} ${online}</div>
        <button class="edit-btn" onclick="editProduct('${prod.id}')">Edit</button>
        <button class="delete-btn" onclick="deleteProduct('${prod.id}')">Delete</button>
      `;
      container.appendChild(div);
    });
  }

  window.editProduct = async function(prodId) {
    const { data: prod, error } = await supabase.from('products').select('*').eq('id', prodId).single();
    if (error || !prod) {
      alert('Failed to load product for editing.');
      return;
    }
    document.getElementById('prod-id').value = prod.id;
    document.getElementById('prod-name').value = prod.name;
    document.getElementById('category').value = prod.category;
    document.getElementById('hsn-code').value = prod.hsn_code;
    document.getElementById('prod-price').value = prod.price;
    document.getElementById('prod-stock').value = prod.stock;
    document.getElementById('prod-desc').value = prod.description || "";
    document.getElementById('cancel-edit-btn').style.display = "inline-block";
    document.querySelector("#product-form button[type=submit]").textContent = "Update Product";
    document.getElementById('accept-cod').checked = Boolean(prod.accept_cod);
    document.getElementById('accept-online').checked = Boolean(prod.accept_online_payment);

    try {
      existingImages = prod.image_url ? JSON.parse(prod.image_url) : [];
    } catch (e) {
      existingImages = prod.image_url ? [prod.image_url] : [];
    }
    selectedFiles = [];
    renderImagePreviews();
  };

  window.deleteProduct = async function(prodId) {
    if (!confirm('Are you sure you want to delete this product?')) return;
    const { error } = await supabase.from('products').delete().eq('id', prodId);
    if (error) {
      alert('Failed to delete product: ' + error.message);
    } else {
      alert('Product deleted successfully!');
      loadSellerProducts();
    }
  };

  document.getElementById('cancel-edit-btn').onclick = resetForm;
  document.getElementById('profile-btn').onclick = () => window.location.href = 'profile.html';
  document.getElementById('orders-btn').onclick = () => window.location.href = 'seller_order.html';
  document.getElementById('logout-btn').onclick = async () => {
    await supabase.auth.signOut();
    window.location.href = 'login.html';
  }

  async function loadSellerReturns() {
    if (!sellerId) return;
    const { data: returns, error } = await supabase
      .from('returns')
      .select('id,quantity,reason,created_at,order_item_id')
      .order('created_at', { ascending: false });
    if (error) {
      document.getElementById('returns-list').textContent = 'Error loading returns: ' + error.message;
      return;
    }

    let html = `<table>
        <thead>
          <tr>
            <th>Return ID</th>
            <th>Product</th>
            <th>Quantity</th>
            <th>Reason</th>
            <th>Customer Email</th>
            <th>Date</th>
          </tr>
        </thead>
        <tbody>`;
    for (const r of returns) {
      const { data: oi } = await supabase
        .from('order_items')
        .select('product_id,seller_id,order_id')
        .eq('id', r.order_item_id)
        .maybeSingle();
      if (!oi || oi.seller_id !== sellerId) continue;
      const { data: prod } = await supabase
        .from('products')
        .select('name')
        .eq('id', oi.product_id)
        .maybeSingle();
      const { data: order } = await supabase
        .from('orders')
        .select('customer_id')
        .eq('id', oi.order_id)
        .maybeSingle();
      let customerEmail = '';
      if (order && order.customer_id) {
        const { data: user } = await supabase
          .from('profiles')
          .select('email')
          .eq('id', order.customer_id)
          .maybeSingle();
        customerEmail = (user && user.email) || '(Unknown)';
      }
      html += `<tr>
        <td>${r.id}</td>
        <td>${prod ? prod.name : 'Unknown'}</td>
        <td>${r.quantity}</td>
        <td>${r.reason}</td>
        <td>${customerEmail}</td>
        <td>${new Date(r.created_at).toLocaleDateString()}</td>
      </tr>`;
    }
    html += `</tbody></table>`;
    document.getElementById('returns-list').innerHTML = html;
  }

  getUser();
</script>
</body>
</html>
