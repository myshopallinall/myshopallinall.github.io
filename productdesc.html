<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Product Details - MyShop</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body { font-family: 'Montserrat', Arial, sans-serif; background: #f8fbfd; margin: 0; color: #222; }
    .header { background: linear-gradient(90deg, #232f3e 70%, #0070f3 100%); color: #fff; padding: 1rem 2rem; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 3px 10px #232f3e44; }
    .header h1 { margin: 0; font-size: 1.9rem; }
    .header button { background: #ffe600; color: #232f3e; border: none; font-weight: bold; padding: 9px 16px; border-radius: 5px; cursor: pointer; }
    main { max-width: 1300px; margin: 2rem auto; background: #fff; border-radius: 10px; box-shadow: 0 2px 16px #e1e8ef; padding: 2rem; }
    .product-layout { display: flex; flex-wrap: wrap; gap: 2rem; }
    .left-content { flex: 1 1 420px; max-width: 450px; text-align: center; }
    .left-content img#mainImage {
      width: 300px;
      height: 300px;
      object-fit: contain;
      border-radius: 10px;
      box-shadow: 0 3px 12px #0001;
      cursor: zoom-in;
      background: #fff;
    }
    .thumbs { margin-top: 1rem; display: flex; justify-content: center; gap: 10px; }
    .thumbs img { width: 70px; height: 70px; border-radius: 6px; border: 2px solid transparent; cursor: pointer; object-fit: cover; }
    .thumbs img.active, .thumbs img:hover { border-color: #0070f3; transform: scale(1.05);}
    .right-content { flex: 1 1 550px; }
    .product-title { font-size: 1.8rem; font-weight: 700; margin-bottom: 0.4rem; color: #232f3e; }
    .price { font-size: 1.6rem; color: #e91e63; margin: 0.5rem 0; }
    .stock { font-weight: bold; color: #22aa44; margin-bottom: 0.8rem; }
    .out-stock { color: #d20000; }
    .quantity-wrap { margin-bottom: 1rem; }
    .quantity-wrap input { width: 70px; padding: 4px; font-size: 1.05rem; }
    .add-cart-btn { background: linear-gradient(90deg, #fbb034 60%, #ed2b77 130%); border: none; color: #fff; padding: 13px 30px; border-radius: 7px; cursor: pointer; font-weight: bold; font-size: 1.05rem; transition: all 0.15s; }
    .add-cart-btn:hover:enabled { background: #0070f3; transform: translateY(-1px);}
    .section { margin-top: 2rem; border-top: 2px solid #f1f2f5; padding-top: 1rem; }
    .section h2 { color: #232f3e; }
    .product-info-table { width: 100%; border-collapse: collapse; }
    .product-info-table td { padding: 8px 6px; border-bottom: 1px solid #eee; }
    .rating-stars { font-size: 1.4rem; color: #ccc; cursor: pointer; }
    .rating-stars span.active { color: #fbb034; }
    .review-section { margin-top: 1.4rem; }
    textarea { width: 100%; border-radius: 6px; border: 1px solid #ccc; padding: 10px; margin-top: 0.4rem; font-family: inherit;}
    button.submit-review { background: #0070f3; color: #fff; border: none; padding: 8px 14px; border-radius: 5px; font-weight: 600; cursor: pointer; margin-top: 8px; }
    .review { background: #f7fafc; border-radius: 6px; margin: 10px 0; padding: 10px;}
    .review strong { color: #0070f3; }
    .comparison-table { border-collapse: collapse; margin: 1rem 0; width: 100%; }
    .comparison-table th, .comparison-table td { padding: 8px 12px; border: 1px solid #e2e4ea; font-size: 1rem;}
    .comparison-table th { background: #f1f3f5; color: #232f3e; }
    .prod-compare-link { color: #0070f3; text-decoration: underline; cursor: pointer;}
.img-modal {
  display: none;
  position: fixed;
  z-index: 9999;
  left: 0; top: 0;
  width: 100vw; height: 100vh;
  background: rgba(40,48,64,0.85);
  align-items: center; justify-content: center;
}

.img-modal-center {
  position: relative;
  display: flex;
  align-items: center;
  justify-content: center;
}

.img-modal img {
  max-width: 98vw;
  max-height: 95vh;
  object-fit: contain;
  border-radius: 14px;
  box-shadow: 0 0 60px #222b;
  background: #fff;
  display: block;
  margin: 0;
}

.img-modal-arrow {
  position: absolute;
  top: 50%;
  transform: translateY(-50%);
  color: #fff;
  background: #222d;
  border: none;
  font-size: 2.4rem;
  width: 44px;
  height: 44px;
  border-radius: 50%;
  cursor: pointer;
  z-index: 10;
  opacity: 0.93;
  transition: background .2s;
  display: flex;
  align-items: center;
  justify-content: center;
}

.img-modal-arrow.left {
  left: -58px;
}

.img-modal-arrow.right {
  right: -58px;
}

.img-modal-close {
  position: absolute;
  top: -18px;
  right: -18px;
  color: #fff;
  font-size: 1.8rem;
  font-weight: bold;
  background: #222f;
  border: none;
  border-radius: 50%;
  width: 36px;
  height: 36px;
  cursor: pointer;
  z-index: 11;
  opacity: 0.95;
  transition: background .2s;
  display: flex;
  align-items: center;
  justify-content: center;
}

@media (max-width: 600px) {
  .img-modal-arrow.left { left: -32px; }
  .img-modal-arrow.right { right: -32px; }
  .img-modal img {
    max-width: 96vw;
    max-height: 80vh;
  }
  .img-modal-close {
    top: -12px;
    right: -12px;
    width: 33px;
    height: 33px;
    font-size: 1.3rem;
  }
}
.img-modal-arrow {
  position: absolute;
  top: 50%;
  transform: translateY(-50%);
  color: #fff;
  background: #222d;
  border: none;
  font-size: 2.4rem;
  width: 44px;
  height: 44px;
  border-radius: 50%;
  cursor: pointer;
  z-index: 10;
  opacity: 0.9;
  transition: background .2s;
  display: flex;
  align-items: center;
  justify-content: center;
}
  </style>
</head>
<body>
<div class="header">
  <h1>MyShop</h1>
  <button onclick="history.back()">← Back</button>
</div>

<!-- ZOOM Modal -->
<div id="imgModal" class="img-modal">
  <div class="img-modal-center">
    <button class="img-modal-arrow left" onclick="moveModalImg(-1)">&#8592;</button>
    <img id="zoomImg" src="" alt="Zoomed Image" />
    <button class="img-modal-arrow right" onclick="moveModalImg(1)">&#8594;</button>
    <button class="img-modal-close" onclick="closeModal()">&times;</button>
  </div>
</div>

<main>
  <section class="product-layout">
    <div class="left-content">
      <img id="mainImage" src="https://via.placeholder.com/400" alt="Product" />
      <div class="thumbs" id="thumbs"></div>
    </div>
    <div class="right-content">
      <div class="product-title" id="prodName">Loading...</div>
      <div class="price" id="prodPrice">₹0</div>
      <div class="stock" id="prodStock"></div>
      <div><strong>Seller:</strong> <span id="prodSeller">-</span></div>
      <div><strong>Category:</strong> <span id="prodCategory">-</span></div>
      <div class="quantity-wrap">
        <label>Quantity:&nbsp;</label>
        <input type="number" id="quantityInput" value="1" min="1" />
      </div>
      <button class="add-cart-btn" id="addToCartBtn">Add to Cart</button>
    </div>
  </section>

  <section class="section">
    <h2>About this item</h2>
    <p id="prodDesc">...</p>
  </section>

  <section class="section">
    <h2>Product Information</h2>
    <table class="product-info-table" id="specsTable"></table>
  </section>

  <section class="section">
    <h2>Compare with Similar Products</h2>
    <table class="comparison-table" id="comparisonTable">
      <thead>
      <tr>
        <th>Product</th>
        <th>Seller</th>
        <th>Price</th>
        <th>Stock</th>
        <th>Rating</th>
        <th>SKU</th>
        <th>Weight</th>
        <th>Dimensions</th>
        <th>GST</th>
        <th>MRP</th>
        <th></th>
      </tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>

  <section class="section">
    <h2>Customer Reviews</h2>
    <div class="rating-stars" id="ratingStars">
      <span data-value="1">★</span>
      <span data-value="2">★</span>
      <span data-value="3">★</span>
      <span data-value="4">★</span>
      <span data-value="5">★</span>
    </div>
    <small id="avgRating">(No ratings yet)</small>
    <div class="review-section">
      <textarea id="reviewText" placeholder="Write your review"></textarea>
      <button class="submit-review" id="submitReview">Submit Review</button>
      <div id="reviewsList"></div>
    </div>
  </section>
</main>

<script>
  const supabase = window.supabase.createClient(
    'https://wamqheltqmufuzrqlxlb.supabase.co',
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndhbXFoZWx0cW11ZnV6cnFseGxiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEwOTQxMzAsImV4cCI6MjA3NjY3MDEzMH0.xFtK5p22bHNzWcGXUgRUR5f-Q4SGdQperlPf4ItD2sY'
  );
  const productId = new URLSearchParams(window.location.search).get('id');
  let productData = null;
  let customerId = null;
  let profileName = null;
let zoomImages = [];
let zoomIndex = 0;

  async function loadProduct() {
    const { data, error } = await supabase
      .from('products')
      .select(`*, profiles(name), categories:category_id(name)`)
      .eq('id', productId)
      .single();
    if (error || !data) {
      document.querySelector('main').innerHTML = '<h2 style="color:red; text-align:center;">Product not found!</h2>';
      return;
    }
    productData = data;
    displayProduct(data);
    await loadReviews();
    loadComparison(data.category_id, data.id);
   }

  function displayProduct(p) {
    document.getElementById('prodName').textContent = p.name;
    document.getElementById('prodPrice').textContent = "₹" + p.price;
    document.getElementById('prodDesc').textContent = p.description || 'No description available.';
    document.getElementById('prodSeller').textContent = p.profiles?.name || 'N/A';
    document.getElementById('prodCategory').textContent = p.categories?.name || p.category_id || 'N/A';
    document.getElementById('prodStock').textContent = p.stock > 0 ? `In Stock (${p.stock})` : 'Out of Stock';
    document.getElementById('prodStock').classList.toggle('out-stock', p.stock <= 0);

    let images = [];
    try { images = JSON.parse(p.image_url); } catch { images = [p.image_url]; }
    if (!images.length) images = ['https://via.placeholder.com/400?text=No+Image'];
    const main = document.getElementById('mainImage');
    const thumbs = document.getElementById('thumbs');
    main.src = images[0];
    // Save images for modal navigation
zoomImages = images;

// Correct opening: pass index to openModal(i)
main.onclick = () => openModal(0);
thumbs.innerHTML = '';
images.forEach((img, i) => {
  let thumb = document.createElement('img');
  thumb.src = img;
  if (i === 0) thumb.classList.add('active');
  thumb.onclick = () => {
    main.src = img;
    thumbs.querySelectorAll('img').forEach(x => x.classList.remove('active'));
    thumb.classList.add('active');
    main.onclick = () => openModal(i);
  };
  thumbs.appendChild(thumb);
});

    // Parse dimension fields
    let dimStr = '-';
    if (p.dimensions) {
      try {
        const dims = typeof p.dimensions === 'string' ? JSON.parse(p.dimensions) : p.dimensions;
        dimStr = `L:${dims.length ?? '-'} W:${dims.width ?? '-'} H:${dims.height ?? '-'}`;
      } catch { dimStr = '-'; }
    }

    const specs = document.getElementById('specsTable');
    specs.innerHTML = `
      <tr><td><b>Product ID</b></td><td>${p.id}</td></tr>
      <tr><td><b>Category</b></td><td>${p.categories?.name || '-'}</td></tr>
      <tr><td><b>Accept COD</b></td><td>${p.accept_cod ? 'Yes' : 'No'}</td></tr>
      <tr><td><b>Available Stock</b></td><td>${p.stock}</td></tr>
      <tr><td><b>HSN Code</b></td><td>${p.hsn_code || '-'}</td></tr>
      <tr><td><b>SKU</b></td><td>${p.sku || '-'}</td></tr>
      <tr><td><b>Weight</b></td><td>${p.weight !== null && p.weight !== undefined ? p.weight + ' kg' : '-'}</td></tr>
      <tr><td><b>Dimensions</b></td><td>${dimStr}</td></tr>
      <tr><td><b>GST Rate</b></td><td>${p.gst_rate !== null && p.gst_rate !== undefined ? p.gst_rate + '%' : '-'}</td></tr>
      <tr><td><b>MRP</b></td><td>${p.mrp !== null && p.mrp !== undefined ? '₹' + p.mrp : '-'}</td></tr>
      <tr><td><b>Featured</b></td><td>${p.featured ? 'Yes' : 'No'}</td></tr>
    `;
  }

function openModal(idx) {
  zoomIndex = idx;
  document.getElementById('imgModal').style.display = 'flex';
  showZoomImg();
}
function closeModal() {
  document.getElementById('imgModal').style.display = 'none';
  document.getElementById('zoomImg').src = '';
}
function showZoomImg() {
  document.getElementById('zoomImg').src = zoomImages[zoomIndex];
}
function moveModalImg(change) {
  if (!zoomImages.length) return;
  zoomIndex = (zoomIndex + change + zoomImages.length) % zoomImages.length;
  showZoomImg();
}
// Close modal on Escape or click outside
document.getElementById('imgModal').addEventListener('click', function(e){
  if(e.target === this) closeModal();
});
document.addEventListener('keydown', function(e){
  if (document.getElementById('imgModal').style.display === 'flex') {
    if(e.key === "Escape") closeModal();
    else if (e.key === "ArrowLeft") moveModalImg(-1);
    else if (e.key === "ArrowRight") moveModalImg(1);
  }
});

  document.getElementById('addToCartBtn').onclick = async () => {
    if (!productData || productData.stock <= 0) return alert("Product out of stock!");
    const qty = parseInt(document.getElementById('quantityInput').value) || 1;
    const { data: user } = await supabase.auth.getUser();
    if (!user.user) return alert("Please login first.");
    customerId = user.user.id;
    await supabase.from('cart').insert([{ customer_id: customerId, product_id: productId, quantity: qty }]);
    alert('Product added to cart!');
  };

  // .............. Review Section ............
  let selectedRating = 0;
  const stars = document.querySelectorAll('#ratingStars span');
  stars.forEach(s => {
    s.onclick = () => {
      selectedRating = parseInt(s.dataset.value);
      stars.forEach(x => x.classList.toggle('active', parseInt(x.dataset.value) <= selectedRating));
    };
  });

  document.getElementById('submitReview').onclick = async () => {
    const text = document.getElementById('reviewText').value.trim();
    if (!selectedRating || text.length < 3) return alert('Select rating and enter review.');
    const { data: user } = await supabase.auth.getUser();
    if (!user.user) return alert("Please login first.");
    customerId = user.user.id;

    let username = profileName;
    if (!username) {
      const { data: profile } = await supabase.from('profiles').select('name').eq('id', customerId).single();
      username = profile?.name || 'Customer';
      profileName = username;
    }

    const { data: prev } = await supabase
      .from('product_reviews')
      .select('*')
      .eq('product_id', productId)
      .eq('customer_id', customerId)
      .maybeSingle();
    if (prev) return alert('You have already reviewed this product.');

    const { error } = await supabase.from('product_reviews')
      .insert([{ product_id: productId, customer_id: customerId, rating: selectedRating, review: text }]);
    if (error) alert("Failed to add review: " + error.message);
    document.getElementById('reviewText').value = '';
    selectedRating = 0;
    stars.forEach(x => x.classList.remove('active'));
    await loadReviews();
  };

  async function loadReviews() {
    const { data, error } = await supabase
      .from('product_reviews')
      .select('rating,review,created_at,customer_id,profiles(name)')
      .eq('product_id', productId)
      .order('created_at', { ascending: false });
    const reviews = data || [];
    const reviewList = document.getElementById('reviewsList');
    reviewList.innerHTML = '';
    let total = 0;
    if (!reviews.length) {
      document.getElementById('avgRating').textContent = '(No ratings yet)';
      return;
    }
    reviews.forEach(r => {
      total += r.rating;
      const div = document.createElement('div');
      div.className = 'review';
      const username = r.profiles?.name || `User...${r.customer_id?.slice(-4)}`;
      div.innerHTML = `<strong>${'★'.repeat(r.rating)}${'☆'.repeat(5-r.rating)}</strong> <span style="float:right;font-size: 0.96em;">${username}</span><br>
        <div style="padding-top:4px">${r.review}</div>
        <div style="color:#9aa0b7; font-size:0.92em;">${new Date(r.created_at).toLocaleDateString()}</div>`;
      reviewList.appendChild(div);
    });
    let avg = (total / reviews.length).toFixed(2);
    document.getElementById('avgRating').textContent = `Average: ${avg}/5 (${reviews.length} reviews)`;
    await supabase.from('products').update({ rating: avg, review_count: reviews.length }).eq('id', productId);
  }

  // .......... Comparison Section ..........
  async function loadComparison(categoryId, skipProductId) {
    const { data, error } = await supabase
      .from('products')
      .select('*')
      .eq('category_id', categoryId)
      .neq('id', skipProductId)
      .limit(5);
    const comparison = data || [];
    const tbody = document.querySelector('#comparisonTable tbody');
    tbody.innerHTML = '';
    if (!comparison.length) {
      tbody.innerHTML = `<tr><td colspan="11" style="text-align:center;">No other products to compare.</td></tr>`;
      return;
    }
    comparison.forEach(prod => {
      let dimStr = '-';
      if (prod.dimensions) {
        try {
          const dims = typeof prod.dimensions === 'string' ? JSON.parse(prod.dimensions) : prod.dimensions;
          dimStr = `L:${dims.length ?? '-'} W:${dims.width ?? '-'} H:${dims.height ?? '-'}`;
        } catch { dimStr = '-'; }
      }
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${prod.name}</td>
        <td>${prod.profiles?.name || '-'}</td>
        <td>₹${prod.price}</td>
        <td>${prod.stock > 0 ? 'In Stock' : 'Out of Stock'}</td>
        <td>${prod.rating ? prod.rating + '/5' : '-'}</td>
        <td>${prod.sku || '-'}</td>
        <td>${prod.weight !== null && prod.weight !== undefined ? prod.weight + ' kg' : '-'}</td>
        <td>${dimStr}</td>
        <td>${prod.gst_rate !== null && prod.gst_rate !== undefined ? prod.gst_rate + '%' : '-'}</td>
        <td>${prod.mrp !== null && prod.mrp !== undefined ? '₹' + prod.mrp : '-'}</td>
        <td><a class="prod-compare-link" href="productdesc.html?id=${prod.id}">View</a></td>
      `;
      tbody.appendChild(tr);
    });
  }

  loadProduct();
</script>
</body>
</html>
