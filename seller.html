<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Seller Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
   font-family: 'Montserrat', Arial, sans-serif;
   background: #f3f4f8;
   margin: 0;
   padding: 0;
   min-height: 100vh;
   color: #222f3e;
 }
 #new-order-popup {
      display: none;
      position: fixed;
      top: 30px;
      left: 50%;
      transform: translateX(-50%);
      background: #ffeee8;
      color: #c12a09;
      border: 2px solid #e54b1c;
      border-radius: 13px;
      box-shadow: 0 10px 35px #e54b1c22, 0 1px 4px #ffd81418;
      padding: 18px 38px;
      font-weight: 700;
      font-size: 1.17em;
      z-index: 1111;
      min-width: 230px;
      text-align: center;
      letter-spacing: .01em;
    }
    #new-order-popup button {
      background:#d22508;color:#fff;border:none;border-radius:21px;padding:6px 24px;margin-left:18px;cursor:pointer;font-weight:bold;font-size:1em;
    }
 nav {
   display: flex;
   justify-content: space-between;
   align-items: center;
   background: linear-gradient(90deg, #232f3e 75%, #fbb034 110%);
   padding: 1.2rem 3vw;
   box-shadow: 0 6px 32px #232f3e16;
 }
 nav h1 {
   font-size: 2.1rem;
   font-weight: 700;
   color: #ffd814;
   letter-spacing: 1.5px;
   margin: 0;
   font-family: 'Montserrat', Arial, sans-serif;
 }
 nav .nav-group {
   display: flex;
   gap: 17px;
 }
 nav button {
   background: #ffd814;
   color: #232f3e;
   font-weight: 600;
   font-size: 1rem;
   border: none;
   border-radius: 6px;
   padding: 11px 24px;
   cursor: pointer;
   transition: background 0.18s, color 0.18s;
   box-shadow: 0 2px 12px #ffd81410, 0 1px 2px #2221;
 }
 nav button:hover {
   background: #232f3e;
   color: #ffd814;
 }


 form {
   background: #fff;
   border-radius: 13px;
   box-shadow: 0 7px 24px #232f3e15;
   padding: 2.4rem 2rem 1.5rem 2rem;
   margin: 2.3rem auto 2rem;
   max-width: 500px;
 }

 form label.option-label {
   font-size: 1.05rem;
   padding: 0 0.25rem 0 0;
   display: inline-block;
   color: #0c1d3c;
 }

 form input, form textarea, form select {
   width: 100%;
   margin: 0.6rem 0 1.0rem 0;
   padding: 0.72rem 1rem;
   font-size: 1.07rem;
   border-radius: 7px;
   border: 1.5px solid #dde5ee;
   box-sizing: border-box;
   background: #f6f8fc;
   color: #232f3e;
   transition: border 0.15s, background 0.15s;
 }

 form input:focus, form textarea:focus, form select:focus {
   border: 2px solid #ffd814;
   outline: none;
   background: #fffce4;
 }

 form select:disabled {
   background: #e9e9ee;
 }

 form button, .edit-btn, .delete-btn {
   background: linear-gradient(90deg,#ffd814 65%,#ed2b77 130%);
   color: #232f3e;
   font-weight: bold;
   font-size: 1.09em;
   border: none;
   border-radius: 8px;
   padding: 13px 34px;
   margin-top: 1rem;
   cursor: pointer;
   box-shadow: 0 3px 14px #ffd81422;
   transition: background .16s, color .16s;
 }
 form button:hover, .edit-btn:hover, .delete-btn:hover {
   background: #222c3e;
   color: #ffd814;
 }

 .cancel-edit-btn {
   background: #e74c3c !important;
   margin-left: 10px;
   color: #fff !important;
 }
 .cancel-edit-btn:hover {
   background: #c0392b !important;
   color: #fff !important;
 }

 .checkbox-row {
   display: flex;
   gap: 26px;
   align-items: center;
   margin: 1.1rem 0;
 }

 h2 {
   font-size: 1.6rem;
   font-weight: bold;
   margin: 2.8rem 0 1.2rem 0;
   color: #232f3e;
   letter-spacing: .02em;
 }

 #products-list {
   display: grid;
   grid-template-columns: repeat(auto-fill,minmax(320px,1fr));
   gap: 2rem 1.3rem;
   margin-bottom: 2.5rem;
 }

 .product-card {
   background: #fff;
   border-radius: 14px;
   box-shadow: 0 8px 36px #232f3e12, 0 2px 10px #ffd81412;
   padding: 1.25rem 1rem 1.5rem 1rem;
   display: flex;
   flex-direction: column;
   align-items: center;
   position: relative;
   transition: box-shadow .15s, transform .11s;
 }

 .product-card:hover {
   box-shadow: 0 16px 50px 0 #ffd81436, 0 0px 35px 0 #232f3e10;
   z-index: 3;
   transform: translateY(-4px) scale(1.014);
 }

 .product-images-gallery {
   display: flex;
   gap: 9px;
   flex-wrap: wrap;
   justify-content: center;
   margin-bottom: 10px;
 }
 .product-images-gallery img {
   width: 62px;
   height: 62px;
   object-fit: cover;
   border-radius: 8px;
   border: 1.5px solid #e3e6f0;
 }

 .product-name {
   font-size: 1.16rem;
   color: #232f3e;
   font-weight: 600;
   margin-bottom: 0.42rem;
   text-align: center;
 }

 .product-price {
   color: #e91e63;
   font-size: 1.1rem;
   font-weight: bold;
   margin-bottom: 0.36rem;
 }

 .product-desc {
   font-size: 0.97rem;
   color: #787c8c;
   margin-bottom: 0.22rem;
   text-align: center;
 }

 .stock-label {
   font-weight: bold;
   font-size: 1.04em;
   margin-bottom: 0.7rem;
   color: #158a00;
   background: #e8ffd7;
   border-radius: 10px;
   padding: 2px 16px;
   display: inline-block;
 }

 .out-stock {
   color: #c8072b;
   background: #ffdffd;
 }

 .option-tag {
   font-size: 0.93rem;
   padding: 2px 9px;
   border-radius: 12px;
   margin: 4px 2px 0 0;
   background: #f6fafc;
   color: #2b3872;
   display: inline-block;
 }

 .cod-yes { color: #148900 !important; background: #e9fcdf;}
 .cod-no { color: #e12d2d !important; background: #ffeaea;}
 .online-yes { color: #1576c1 !important; background: #e6f2fd;}
 .online-no { color: #a67500 !important; background: #fff2da;}

 .edit-btn { background: #27ae60 !important; color: #fff; }
 .delete-btn { background: #e74c3c !important; color: #fff; margin-left: 9px; }

 .image-preview-container {
   display: flex;
   flex-wrap: wrap;
   gap: 11px;
   margin: 15px 0;
 }
 .image-preview-item {
   position: relative;
   width: 80px;
   height: 80px;
   border: 2px solid #dde5ee;
   border-radius: 7px;
   overflow: hidden;
   background: #f6f8fc;
 }
 .image-preview-item img {
   width: 100%;
   height: 100%;
   object-fit: cover;
 }
 .image-preview-item .remove-img {
   position: absolute;
   top: 2px;
   right: 2px;
   background: #e74c3c;
   color: white;
   border: none;
   border-radius: 50%;
   width: 24px;
   height: 24px;
   cursor: pointer;
   font-size: 16px;
   line-height: 20px;
   z-index: 2;
 }
 .image-preview-item .remove-img:hover {
   background: #c0392b;
 }
 .image-preview-item .size-badge {
   position: absolute;
   bottom: 2px;
   left: 2px;
   background: rgba(0,0,0,0.74);
   color: white;
   font-size: 10px;
   padding: 2px 5px;
   border-radius: 3px;
 }

 #returns-list table {
   width: 100%;
   border-collapse: collapse;
   margin-top: 1.7rem;
   font-size: 1.03rem;
   background: #fff;
   box-shadow: 0 5px 24px #232f3e0b;
 }
 #returns-list th, #returns-list td {
   border: 1px solid #dde5ee;
   padding: 10px 10px;
   text-align: left;
 }
 #returns-list th {
   background-color: #232f3e;
   color: #ffd814;
   font-weight: 700;
   letter-spacing: .02em;
 }

 .compression-info {
   font-size: 0.93rem;
   color: #78809a;
   margin-top: 4px;
   margin-bottom: 8px;
 }

 @media (max-width: 700px) {
   form { padding: 1.3rem 4vw; }
   #products-list { grid-template-columns: 1fr; gap: .8rem;}
   .product-card { padding: .8rem .4rem 1.1rem .4rem;}
   nav h1 { font-size: 1.22rem;}
   h2 { font-size: 1.1rem;}
 }

    <div id="orderNotification" style="
  display:none;
  position:fixed;
  top:32px;
  left:50%;
  transform:translateX(-50%);
  background: #ffeee8;
  color: #c12a09;
  border: 2px solid #e54b1c;
  border-radius: 11px;
  box-shadow: 0 8px 50px #e54b1c22, 0 3px 11px #ffd81413;
  padding: 18px 38px 18px 38px;
  font-weight: 700;
  font-size: 1.18em;
  z-index: 1000;
  min-width: 220px;
  text-align: center;
  letter-spacing: .01em;
">
  <span id="orderNotifText"></span>
  <button onclick="document.getElementById('orderNotification').style.display='none'"
    style="background:#d22508;color:#fff;border:none;border-radius:21px;padding:4.5px 24px; margin-left:18px;cursor:pointer;font-weight:bold;">
    Close
  </button>
</div>

  </style>
</head>
<body>

<nav>
  <h1>Seller Dashboard</h1>
  <div class="nav-group">
    <button id="profile-btn">Profile</button>
    <button id="orders-btn">Seller Orders</button>
    <button id="logout-btn">Logout</button>
    </div>
</nav>
<div id="new-order-popup">
  <span id="new-order-text"></span>
  <button onclick="document.getElementById('new-order-popup').style.display='none'">Close</button>
</div>

<form id="product-form">
  <input type="hidden" id="prod-id" />
  <input type="text" id="prod-name" placeholder="Product Name" required />

  <select id="category" required>
    <option value="" disabled selected>Select Category</option>
  </select>
  <select id="subcategory" required disabled>
    <option value="" disabled selected>Select Subcategory</option>
  </select>
  <input type="text" id="hsn-code" placeholder="HSN Code" />
  <input type="text" id="prod-sku" placeholder="SKU" />
  <input type="number" step="0.001" min="0" id="prod-weight" placeholder="Weight (kg)" />

  <input type="number" min="0" step="0.01" id="dim-length" placeholder="Length" />
  <input type="number" min="0" step="0.01" id="dim-width" placeholder="Width" />
  <input type="number" min="0" step="0.01" id="dim-height" placeholder="Height" />

  <input type="number" step="0.01" min="0" id="prod-price" placeholder="Price (₹)" required />
  <input type="number" step="0.01" min="0" id="gst-rate" placeholder="GST Rate (%)" required />
  <input type="number" step="0.01" min="0" id="mrp-price" placeholder="MRP (₹)" required />
  <input type="number" min="0" id="prod-stock" placeholder="Stock (Qty)" required />
  <textarea id="prod-desc" placeholder="Description"></textarea>
  <label for="prod-image-file" style="display:block; margin-top:10px; font-weight:bold;">Product Images (Max 5, compressed ~50KB)</label>
  <input type="file" id="prod-image-file" accept="image/*" multiple />
  <div class="compression-info" id="compression-info"></div>
  <div id="image-preview-container" class="image-preview-container"></div>
  <div class="checkbox-row" style="margin:0.8rem 0;">
    <label class="option-label"><input type="checkbox" id="accept-cod" checked /> Accept COD</label>
    <label class="option-label"><input type="checkbox" id="accept-online" checked /> Accept Online Payment</label>
  </div>
  <label>Delivery Locations (Multiple Pincodes)</label>
  <form id="delivery-location-form" style="display:flex; gap:8px; margin-bottom:10px;">
    <input
            type="text"
            id="delivery-pincode-input"
            placeholder="Enter 6-digit pincode"
            maxlength="6"
            pattern="\d{6}"
            inputmode="numeric"
            title="Enter a valid 6-digit pincode"
    />
    <button type="button" id="add-pincode-btn">Add</button>

  <ul id="delivery-pincode-list" style="list-style: disc inside; margin-top:0; padding-left:10px;"></ul>

  <button type="submit">Add Product</button>
  <button type="button" id="cancel-edit-btn" class="cancel-edit-btn" style="display:none;">Cancel Edit</button>
</form>

<h2>Your Products</h2>
<div id="products-list"></div>

<h2>Return Requests</h2>
<div id="returns-list"></div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  const supabase = window.supabase.createClient(
    'https://wamqheltqmufuzrqlxlb.supabase.co',
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndhbXFoZWx0cW11ZnV6cnFseGxiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEwOTQxMzAsImV4cCI6MjA3NjY3MDEzMH0.xFtK5p22bHNzWcGXUgRUR5f-Q4SGdQperlPf4ItD2sY'
  );
const length = parseFloat(document.getElementById('dim-length').value) || 0;
const width = parseFloat(document.getElementById('dim-width').value) || 0;
const height = parseFloat(document.getElementById('dim-height').value) || 0;

const dimensions = {
  length: length,
  width: width,
  height: height
};

  // --- POPUP: New Seller Orders ---
  async function checkNewOrdersPopup() {
    const { data: { user } } = await supabase.auth.getUser();
    if (!user) return;
    const { data: orderItems, error } = await supabase
      .from('order_items')
      .select('order_id')
      .eq('seller_id', user.id)
      .in('delivery_status', ['placed', 'pending']);
    if (error || !orderItems) return;
    const uniqueOrders = Array.from(new Set(orderItems.map(i => i.order_id)));
    if (uniqueOrders.length > 0) {
      document.getElementById('new-order-text').textContent =
        `You have ${uniqueOrders.length} new order${uniqueOrders.length > 1 ? "s" : ""} placed or pending.`;
      document.getElementById('new-order-popup').style.display = 'block';
    } else {
      document.getElementById('new-order-popup').style.display = 'none';
    }
  }
  // Run popup check on load and every 60s
  setInterval(checkNewOrdersPopup, 2000);
  let sellerId = null, selectedFiles = [], existingImages = [];
  let allCategoriesList = [];
let deliveryPincodes = new Set();

const deliveryPincodeInput = document.getElementById('delivery-pincode-input');
const deliveryPincodeList = document.getElementById('delivery-pincode-list');

function renderDeliveryPincodes() {
  deliveryPincodeList.innerHTML = '';
  if (deliveryPincodes.size === 0) {
    deliveryPincodeList.innerHTML = '<li>No delivery pincodes added.</li>';
    return;
  }
  deliveryPincodes.forEach(pin => {
    const li = document.createElement('li');
    li.textContent = pin;

    const removeBtn = document.createElement('button');
    removeBtn.textContent = 'Remove';
    removeBtn.style.marginLeft = '10px';
    removeBtn.onclick = () => {
      deliveryPincodes.delete(pin);
      renderDeliveryPincodes();
    };

    li.appendChild(removeBtn);
    deliveryPincodeList.appendChild(li);
  });
}

function isValidPincode(pin) {
  return /^\d{6}$/.test(pin);
}

document.getElementById('add-pincode-btn').onclick = () => {
  const val = deliveryPincodeInput.value.trim();
  if (!isValidPincode(val)) {
    alert('Please enter a valid 6-digit pincode');
    return;
  }
  if (deliveryPincodes.has(val)) {
    alert('Pincode already added');
    return;
  }
  deliveryPincodes.add(val);
  deliveryPincodeInput.value = '';
  renderDeliveryPincodes();
};

renderDeliveryPincodes();

  async function getUser() {
    const { data } = await supabase.auth.getUser();
    if (data && data.user) {
      sellerId = data.user.id;
      await checkSellerDetails();
      await loadCategories();
      await loadSellerProducts();
      await loadSellerReturns();
      await checkNewOrdersPopup();

    } else {
      alert('Please log in first!');
      window.location.href = 'login.html';
    }
  }

  async function checkSellerDetails() {
    const { data, error } = await supabase.from('profiles').select('gst_number, pan_number').eq('id', sellerId).single();
    if (error || !data) {
      alert('Could not get seller details. Please login again.');
      window.location.href = 'login.html';
      return;
    }
    if (!data.gst_number || !data.pan_number) {
      alert('Please update your GST and PAN numbers in your profile before adding products.');
      window.location.href = 'profile.html';
    }
  }

  async function loadCategories() {
    const { data, error } = await supabase
      .from('categories')
      .select('id, name, parent_id');
    if (error) {
      alert('Failed to load categories: ' + error.message);
      return;
    }
    allCategoriesList = data;
    const categories = data.filter(c => c.parent_id === null);
    const categorySelect = document.getElementById('category');
    categorySelect.innerHTML = '<option value="" disabled selected>Select Category</option>';
    categories.forEach(cat => {
      const option = document.createElement('option');
      option.value = cat.id;
      option.textContent = cat.name;
      categorySelect.appendChild(option);
    });
    categorySelect.onchange = () => {
      const subcatSelect = document.getElementById('subcategory');
      subcatSelect.innerHTML = '<option value="" disabled selected>Select Subcategory</option>';
      subcatSelect.disabled = true;
      const selectedCat = parseInt(categorySelect.value);
      const subCategories = data.filter(c => c.parent_id === selectedCat);
      if (subCategories.length > 0) {
        subcatSelect.disabled = false;
        subCategories.forEach(subcat => {
          const opt = document.createElement('option');
          opt.value = subcat.id;
          opt.textContent = subcat.name;
          subcatSelect.appendChild(opt);
        });
      }
    };
  }
  async function compressImage(file, targetSizeKB = 50) {
    return new Promise((resolve) => {
      const reader = new FileReader();
      reader.onload = (e) => {
        const img = new Image();
        img.onload = () => {
          const canvas = document.createElement('canvas');
          const ctx = canvas.getContext('2d');
          let width = img.width;
          let height = img.height;
          const maxSize = 800;
          if (width > maxSize || height > maxSize) {
            if (width > height) {
              height = (height / width) * maxSize;
              width = maxSize;
            } else {
              width = (width / height) * maxSize;
              height = maxSize;
            }
          }
          canvas.width = width;
          canvas.height = height;
          ctx.drawImage(img, 0, 0, width, height);

          let quality = 0.9;
          let blob = null;
          let iterations = 0;
          const maxIterations = 10;

          const tryCompress = (q) => new Promise((res) => canvas.toBlob(res, 'image/jpeg', q));

          const compress = async () => {
            while (iterations < maxIterations) {
              blob = await tryCompress(quality);
              const sizeKB = blob.size / 1024;
              if (sizeKB <= targetSizeKB * 1.1 && sizeKB >= targetSizeKB * 0.8) break;
              quality += (sizeKB > targetSizeKB) ? -0.1 : 0.05;
              quality = Math.max(0.1, Math.min(1, quality));
              iterations++;
            }
            const finalFile = new File([blob], file.name, { type: 'image/jpeg' });
            resolve({ file: finalFile, size: blob.size });
          };

          compress();
        };
        img.src = e.target.result;
      };
      reader.readAsDataURL(file);
    });
  }

  document.getElementById('prod-image-file').addEventListener('change', async (e) => {
    const files = Array.from(e.target.files);
    if (selectedFiles.length + files.length > 5) {
      alert('You can upload maximum 5 images');
      return;
    }
    const compressionInfo = document.getElementById('compression-info');
    compressionInfo.textContent = 'Compressing images...';
    for (const file of files) {
      if (selectedFiles.length < 5) {
        try {
          const { file: compressedFile, size } = await compressImage(file, 50);
          selectedFiles.push({ original: file, compressed: compressedFile, size });
        } catch (error) {
          alert('Failed to compress image: ' + file.name);
        }
      }
    }
    compressionInfo.textContent = `${selectedFiles.length} image(s) compressed successfully!`;
    setTimeout(() => { compressionInfo.textContent = ''; }, 3000);
    renderImagePreviews();
  });

  function renderImagePreviews() {
    const container = document.getElementById('image-preview-container');
    container.innerHTML = '';

    existingImages.forEach((url, index) => {
      const div = document.createElement('div');
      div.className = 'image-preview-item';
      div.innerHTML = `
        <img src="${url}" />
        <button class="remove-img" type="button" onclick="removeExistingImage(${index})">&times;</button>
      `;
      container.appendChild(div);
    });

    selectedFiles.forEach((fileObj, index) => {
      const reader = new FileReader();
      reader.onload = e => {
        const sizeKB = (fileObj.size / 1024).toFixed(1);
        const div = document.createElement('div');
        div.className = 'image-preview-item';
        div.innerHTML = `
          <img src="${e.target.result}" />
          <span class="size-badge">${sizeKB}KB</span>
          <button class="remove-img" type="button" onclick="removeSelectedFile(${index})">&times;</button>
        `;
        container.appendChild(div);
      };
      reader.readAsDataURL(fileObj.compressed);
    });
  }

  window.removeSelectedFile = function(index) {
    selectedFiles.splice(index, 1);
    renderImagePreviews();
  };

  window.removeExistingImage = function(index) {
    existingImages.splice(index, 1);
    renderImagePreviews();
  };

  async function uploadImage(file) {
    const fileName = `products/${sellerId}/${Date.now()}_${Math.random().toString(36).substring(2,10)}_${file.name}`;
    const { error } = await supabase.storage.from('product-images').upload(fileName, file, { upsert: true });
    if (error) {
      alert('Image upload failed: ' + error.message);
      return null;
    }
    const { data } = supabase.storage.from('product-images').getPublicUrl(fileName);
    return data.publicUrl;
  }

  document.getElementById('product-form').onsubmit = async (e) => {
  e.preventDefault();

const prodId = document.getElementById('prod-id').value;

  const name = document.getElementById('prod-name').value.trim();
  const categoryId = document.getElementById('category').value;
  const subcategoryId = document.getElementById('subcategory').value || null;
  const hsn_code = document.getElementById('hsn-code').value.trim() || null;
  const price = parseFloat(document.getElementById('prod-price').value);
  const stock = parseInt(document.getElementById('prod-stock').value, 10);
  const description = document.getElementById('prod-desc').value.trim() || null;
  const accept_cod = document.getElementById('accept-cod').checked;
  const accept_online_payment = document.getElementById('accept-online').checked;
  const gstRate = parseFloat(document.getElementById('gst-rate').value);
  const mrpPrice = parseFloat(document.getElementById('mrp-price').value);
  const sku = document.getElementById('prod-sku').value.trim() || null;
  const weightRaw = document.getElementById('prod-weight').value;
  const weight = weightRaw === '' ? null : parseFloat(weightRaw);

  const length = parseFloat(document.getElementById('dim-length').value) || 0;
  const width = parseFloat(document.getElementById('dim-width').value) || 0;
  const height = parseFloat(document.getElementById('dim-height').value) || 0;
  const dimensions = { length, width, height };

  // Basic validation
  if (!name || !categoryId || isNaN(price) || isNaN(stock) || isNaN(gstRate) || isNaN(mrpPrice) || (weight !== null && isNaN(weight))) {
    alert('Please fill required fields correctly.');
    return;
  }

  let imageUrls = [...existingImages];
  for (const fileObj of selectedFiles) {
    const url = await uploadImage(fileObj.compressed);
    if (url) imageUrls.push(url);
  }

  const productData = {
    seller_id: sellerId,
    name,
    category_id: subcategoryId || categoryId,
    hsn_code,
    price,
    stock,
    description,
    accept_cod,
    accept_online_payment,
    sku,
    weight,
    dimensions,
    gst_rate: gstRate,
    mrp: mrpPrice,
    image_url: imageUrls.length ? JSON.stringify(imageUrls) : null,
    delivery_location: Array.from(deliveryPincodes)
  };

  if (prodId) {
  const { data, error } = await supabase.from('products')
    .update(productData)
    .eq('id', prodId);

  if (error) {
    console.error('Update error:', error);
    alert('Failed to update product: ' + error.message);
  } else {
    alert('Product updated successfully!');
    resetForm();
    loadSellerProducts();
  }
} else {
const { error } = await supabase.from('products')
      .insert([productData]);
    if (error) {
      alert('Failed to add product: ' + error.message);
    } else {
      alert('Product added successfully!');
      resetForm();
      loadSellerProducts();
    }
  }
};
  function resetForm() {
    document.getElementById('product-form').reset();
    document.getElementById('prod-id').value = '';
    document.getElementById('cancel-edit-btn').style.display = 'none';
    document.querySelector('#product-form button[type=submit]').textContent = 'Add Product';
    document.getElementById('accept-cod').checked = true;
    document.getElementById('accept-online').checked = true;
    selectedFiles = [];
    existingImages = [];
    renderImagePreviews();
  }

  async function loadSellerProducts() {
    const { data, error } = await supabase.from('products').select('*').eq('seller_id', sellerId).order('created_at', { ascending: false });
    if (error) {
      alert('Error loading products: ' + error.message);
      return;
    }
    const container = document.getElementById('products-list');
    container.innerHTML = '';
    data.forEach(prod => {
      const codTag = prod.accept_cod ? '<span class="option-tag cod-yes">COD</span>' : '<span class="option-tag cod-no">No COD</span>';
      const onlineTag = prod.accept_online_payment ? '<span class="option-tag online-yes">Online</span>' : '<span class="option-tag online-no">No Online</span>';

      let images = [];
      try {
        images = prod.image_url ? JSON.parse(prod.image_url) : [];
      } catch {
        images = prod.image_url ? [prod.image_url] : [];
      }

      let imagesHtml = '';
      if (images.length) {
        imagesHtml = '<div class="product-images-gallery">';
        images.forEach(url => {
          imagesHtml += `<img src="${url}" alt="${prod.name}"/>`;
        });
        imagesHtml += '</div>';
      } else {
        imagesHtml = '<img src="https://via.placeholder.com/120" alt="No image"/>';
      }

      const div = document.createElement('div');
      div.className = 'product-card';
      div.innerHTML = `
        ${imagesHtml}
        <div class="product-name">${prod.name}</div>
        <div><b>Category ID:</b> ${prod.category_id || '-'}</div>
        <div><b>HSN Code:</b> ${prod.hsn_code || '-'}</div>

        <div class="product-price">₹${prod.price.toFixed(2)}</div>
     <div><b>SKU:</b> ${prod.sku || '-'}</div>
<div><b>Weight:</b> ${prod.weight ? prod.weight.toFixed(3) + ' kg' : '-'}</div>
<div><b>Dimensions:</b> ${prod.dimensions ? JSON.stringify(prod.dimensions) : '-'}</div>

        <div><b>GST Rate:</b> ${prod.gst_rate ? prod.gst_rate + '%' : '-'}</div>
        <div><b>MRP:</b> ₹${prod.mrp ? prod.mrp.toFixed(2) : '-'}</div>
   <div class="product-desc">${prod.description || ''}</div>

        <div>
          <span class="stock-label ${prod.stock > 0 ? 'in-stock':'out-stock'}">
            ${prod.stock > 0 ? 'In Stock (' + prod.stock + ')':'Out of Stock'}
          </span>
        </div>
        <div style="margin-top:6px;">${codTag} ${onlineTag}</div>
        <button class="edit-btn" onclick="editProduct('${prod.id}')">Edit</button>
        <button class="delete-btn" onclick="deleteProduct('${prod.id}')">Delete</button>
      `;
      container.appendChild(div);
    });
  }

  async function editProduct(prodId) {
    const { data: prod, error } = await supabase.from('products').select('*').eq('id', prodId).single();
    if (error || !prod) {
      alert('Failed to load product for editing.');
      return;
    }
    document.getElementById('prod-id').value = prod.id;
    document.getElementById('prod-name').value = prod.name;
    document.getElementById('category').value = prod.category_id || '';
    document.getElementById('hsn-code').value = prod.hsn_code || '';
    document.getElementById('prod-sku').value = prod.sku || '';
    document.getElementById('prod-weight').value = prod.weight || '';
if (prod.dimensions) {
  try {
    const dims = prod.dimensions;
    document.getElementById('dim-length').value = dims.length || '';
    document.getElementById('dim-width').value = dims.width || '';
    document.getElementById('dim-height').value = dims.height || '';
  } catch (e) {
    document.getElementById('dim-length').value = '';
    document.getElementById('dim-width').value = '';
    document.getElementById('dim-height').value = '';
  }
} else {
  document.getElementById('dim-length').value = '';
  document.getElementById('dim-width').value = '';
  document.getElementById('dim-height').value = '';
}

    document.getElementById('prod-price').value = prod.price;
    document.getElementById('gst-rate').value = prod.gst_rate ?? '';
    document.getElementById('mrp-price').value = prod.mrp ?? '';

    document.getElementById('prod-stock').value = prod.stock;
    document.getElementById('prod-desc').value = prod.description || '';
    document.getElementById('cancel-edit-btn').style.display = 'inline-block';
    document.querySelector('#product-form button[type=submit]').textContent = 'Update Product';
    document.getElementById('accept-cod').checked = Boolean(prod.accept_cod);
    document.getElementById('accept-online').checked = Boolean(prod.accept_online_payment);
try {
  const deliveryLocs = prod.delivery_location || [];
  deliveryPincodes = new Set(deliveryLocs);
} catch {
  deliveryPincodes = new Set();
}
renderDeliveryPincodes();


    try {
      existingImages = prod.image_url ? JSON.parse(prod.image_url) : [];
    } catch {
      existingImages = prod.image_url ? [prod.image_url] : [];
    }
    selectedFiles = [];
    renderImagePreviews();
  }

  async function deleteProduct(prodId) {
    if (!confirm('Are you sure you want to delete this product?')) return;
    const { error } = await supabase.from('products').delete().eq('id', prodId);
    if (error) alert('Failed to delete product: ' + error.message);
    else {
      alert('Product deleted successfully!');
      loadSellerProducts();
    }
  }

  document.getElementById('cancel-edit-btn').onclick = resetForm;
  document.getElementById('profile-btn').onclick = () => window.location.href = 'profile.html';
  document.getElementById('orders-btn').onclick = () => window.location.href = 'seller_order.html';
  document.getElementById('logout-btn').onclick = async () => {
    await supabase.auth.signOut();
    window.location.href = 'login.html';
  };

  async function loadSellerReturns() {
    if (!sellerId) return;
    const { data: returns, error } = await supabase
      .from('returns')
      .select('id,quantity,reason,created_at,order_item_id')
      .order('created_at', { ascending: false });
    if (error) {
      document.getElementById('returns-list').textContent = 'Error loading returns: ' + error.message;
      return;
    }

    let html = `<table>
      <thead>
        <tr>
          <th>Return ID</th>
          <th>Product</th>
          <th>Quantity</th>
          <th>Reason</th>
          <th>Customer Email</th>
          <th>Date</th>
        </tr>
      </thead>
      <tbody>`;

    for (const r of returns) {
      const { data: oi } = await supabase.from('order_items').select('product_id,seller_id,order_id').eq('id', r.order_item_id).maybeSingle();
      if (!oi || oi.seller_id !== sellerId) continue;
      const { data: prod } = await supabase.from('products').select('name').eq('id', oi.product_id).maybeSingle();
      const { data: order } = await supabase.from('orders').select('customer_id').eq('id', oi.order_id).maybeSingle();
      let customerEmail = '';
      if (order && order.customer_id) {
        const { data: user } = await supabase.from('profiles').select('email').eq('id', order.customer_id).maybeSingle();
        customerEmail = (user && user.email) || '(Unknown)';
      }
      html += `<tr>
        <td>${r.id}</td>
        <td>${prod ? prod.name : 'Unknown'}</td>
        <td>${r.quantity}</td>
        <td>${r.reason}</td>
        <td>${customerEmail}</td>
        <td>${new Date(r.created_at).toLocaleDateString()}</td>
      </tr>`;
    }
    html += `</tbody></table>`;
    document.getElementById('returns-list').innerHTML = html;
  }

  getUser();
</script>
</body>
</html>
